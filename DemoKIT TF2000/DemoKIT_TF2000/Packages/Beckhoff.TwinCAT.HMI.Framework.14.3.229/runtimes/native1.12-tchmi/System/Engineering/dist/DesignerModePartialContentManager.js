import{SyncCmdToCreatorRequestCurrentPartialContent}from"./SyncCmdToCreatorRequestCurrentPartialContent.js";import{designerModeComManager}from"./DesignerModeComManager.js";import{SyncCmdToCreatorRequestCurrentPartialContents}from"./SyncCmdToCreatorRequestCurrentPartialContents.js";TCHMI_ENGINEERING||TcHmi.Log.errorEx(`Internal error: The file "${import.meta.url}" is restricted to use within the designer or live view.`);export class DesignerModePartialContentManager{constructor(){}__requestsSingle=new Map;__requestsMulti=new Map;__requestIdCount=0;requestCurrentPartialContents(partialUrls,callback){if(!partialUrls.length)return window.queueMicrotask(()=>{TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE,targetPartials:[]})}),()=>{};const listOfRequestIds=[];return designerModeComManager.initializedTwowayCommunication.then(()=>{if(designerModeComManager.supportedCommandFromVS.includes("RequestCurrentPartialContents")){let resolve,reject;const promise=new Promise((_resolve,_reject)=>{resolve=_resolve,reject=_reject});let requestId=this.createRequestId("multi");if(null===requestId)return;listOfRequestIds.push(requestId);const piggyBack=JSON.stringify({requestId,requestInstance:TCHMI_DYNAMIC_INSTANCE_ID}),requestObject={resolve,reject};this.__requestsMulti.set(requestId,requestObject),new SyncCmdToCreatorRequestCurrentPartialContents({name:"RequestCurrentPartialContents",targetPartials:partialUrls,piggyBack,replyTo:TCHMI_DYNAMIC_INSTANCE_ID}).send(),TcHmi.System.promiseTimeout(promise,{timeout:TcHmi.System.config.tcHmiServer.websocketSystemTimeout,rejectDetails:{code:TcHmi.Errors.E_TIMEOUT,message:TcHmi.Errors[TcHmi.Errors.E_TIMEOUT],domain:"TcHmi.System.Engineering.DesignerModePartialContentManager"}}).then(data=>{if(null!==requestId&&this.__requestsMulti.delete(requestId),data.some(item=>null===item.content)){const contentsWithErrors=data.filter(item=>null===item.content).map(item=>item.path);TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.ERROR,targetPartials:data,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:"The following partials could not be loaded from engineering: "+contentsWithErrors.join(", "),domain:"TcHmi.System.Engineering.DesignerModePartialContentManager"}})}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE,targetPartials:data})}).catch(error=>{null!==requestId&&this.__requestsMulti.delete(requestId),TcHmi.Callback.callSafeEx(callback,null,{error:error instanceof TcHmi.Exception?error.code:TcHmi.Errors.E_EXCEPTION,details:error instanceof TcHmi.Exception?error.details:void 0,targetPartials:partialUrls.map(url=>({path:url.path,content:null}))})})}else{const listOfPromises=[];for(const partialUrl of partialUrls){let resolve,reject;const promise=new Promise((_resolve,_reject)=>{resolve=_resolve,reject=_reject});listOfPromises.push(promise);let requestId=this.createRequestId("single");if(null===requestId)return;listOfRequestIds.push(requestId);const piggyBack=JSON.stringify({requestId,requestInstance:TCHMI_DYNAMIC_INSTANCE_ID}),requestObject={resolve,reject};this.__requestsSingle.set(requestId,requestObject),new SyncCmdToCreatorRequestCurrentPartialContent({name:"RequestCurrentPartialContent",targetPartial:partialUrl.path,piggyBack,replyTo:TCHMI_DYNAMIC_INSTANCE_ID}).send()}TcHmi.System.promiseTimeout(Promise.all(listOfPromises),{timeout:TcHmi.System.config.tcHmiServer.websocketSystemTimeout,rejectDetails:{code:TcHmi.Errors.E_TIMEOUT,message:TcHmi.Errors[TcHmi.Errors.E_TIMEOUT],domain:"TcHmi.System.Engineering.DesignerModePartialContentManager"}}).then(data=>{TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE,targetPartials:data})}).catch(error=>{TcHmi.Callback.callSafeEx(callback,null,{error:error instanceof TcHmi.Exception?error.code:TcHmi.Errors.E_EXCEPTION,details:error instanceof TcHmi.Exception?error.details:void 0,targetPartials:partialUrls.map(url=>({path:url.path,content:null}))})}).finally(()=>{for(const requestId of listOfRequestIds)this.__requestsSingle.delete(requestId)})}}),()=>{for(const requestId of listOfRequestIds){const requestObj=this.__requestsMulti.get(requestId)??this.__requestsSingle.get(requestId);requestObj?.reject(new TcHmi.Exception({code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:"Request destroyed by user."}))}}}createRequestId(type){const requestCache="multi"===type?this.__requestsMulti:this.__requestsSingle;let requestId=0,loopcount=0;do{if(requestId=0,loopcount++,loopcount>=1e6){TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModePartialContentManager] Reached maxium of parallel requests."),requestId=null;break}this.__requestIdCount++,this.__requestIdCount>=1e6&&(this.__requestIdCount=1),requestId=this.__requestIdCount}while(requestCache.has(requestId));return requestId}getRequestSingle(requestId){return this.__requestsSingle.get(requestId)}getRequestMulti(requestId){return this.__requestsMulti.get(requestId)}}export const partialContentManager=new DesignerModePartialContentManager;