var __runInitializers=this&&this.__runInitializers||function(thisArg,initializers,value){for(var useValue=arguments.length>2,i=0;i<initializers.length;i++)value=useValue?initializers[i].call(thisArg,value):initializers[i].call(thisArg);return useValue?value:void 0},__esDecorate=this&&this.__esDecorate||function(ctor,descriptorIn,decorators,contextIn,initializers,extraInitializers){function accept(f){if(void 0!==f&&"function"!=typeof f)throw new TypeError("Function expected");return f}for(var _,kind=contextIn.kind,key="getter"===kind?"get":"setter"===kind?"set":"value",target=!descriptorIn&&ctor?contextIn.static?ctor:ctor.prototype:null,descriptor=descriptorIn||(target?Object.getOwnPropertyDescriptor(target,contextIn.name):{}),done=!1,i=decorators.length-1;i>=0;i--){var context={};for(var p in contextIn)context[p]="access"===p?{}:contextIn[p];for(var p in contextIn.access)context.access[p]=contextIn.access[p];context.addInitializer=function(f){if(done)throw new TypeError("Cannot add initializers after decoration has completed");extraInitializers.push(accept(f||null))};var result=(0,decorators[i])("accessor"===kind?{get:descriptor.get,set:descriptor.set}:descriptor[key],context);if("accessor"===kind){if(void 0===result)continue;if(null===result||"object"!=typeof result)throw new TypeError("Object expected");(_=accept(result.get))&&(descriptor.get=_),(_=accept(result.set))&&(descriptor.set=_),(_=accept(result.init))&&initializers.unshift(_)}else(_=accept(result))&&("field"===kind?initializers.unshift(_):descriptor[key]=_)}target&&Object.defineProperty(target,contextIn.name,descriptor),done=!0};import{metaDataManager}from"./DesignerModeControlMetaDataMngr.js";import{designerModeManager}from"./DesignerModeManager.js";import{rootControlManager}from"./DesignerModeMasterRootControlMngr.js";import{SyncCmdToCreatorZoom}from"./SyncCmdToCreatorZoom.js";TCHMI_DESIGNER||TcHmi.Log.errorEx(`Internal error: The file "${import.meta.url}" is restricted to use within the designer.`);let DesignerModeMasterInteractionManager=(()=>{var _a;let ___handleDesignerWheelEvents_decorators,_instanceExtraInitializers=[];return class{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;___handleDesignerWheelEvents_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],__esDecorate(this,null,___handleDesignerWheelEvents_decorators,{kind:"method",name:"__handleDesignerWheelEvents",static:!1,private:!1,access:{has:obj=>"__handleDesignerWheelEvents"in obj,get:obj=>obj.__handleDesignerWheelEvents},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}constructor(){this.__modifierKeyPressed={ctrl:!1,shift:!1},this.__startMousePosition={left:0,top:0},this.__startMousePositionCopyMoveOffsetPosition={left:0,top:0},this.__positionInsideControl={top:0,left:0,height:0,width:0},document.documentElement.addEventListener("wheel",this.__handleDesignerWheelEvents,{passive:!1})}__verPositionCache=(__runInitializers(this,_instanceExtraInitializers),{});__horPositionCache={};__modifierKeyPressed;__startMousePosition;__startMousePositionCopyMoveOffsetPosition;__positionInsideControl;__anchorName=void 0;getAnchorName(){return this.__anchorName}setAnchorName(newAnchorName){this.__anchorName=newAnchorName}getStartMousePos(){return this.__startMousePosition}getStartMousePosCopyMoveOffsetPosition(){return this.__startMousePositionCopyMoveOffsetPosition}getPositionInsideControl(){return this.__positionInsideControl}setCtrlModifierKeyState(bState){this.__modifierKeyPressed.ctrl=bState}setShiftModifierKeyState(bState){this.__modifierKeyPressed.shift=bState}clearControlSnapPositionCache(){this.__horPositionCache={},this.__verPositionCache={}}handleInteractionStart(event,activeControl){if(void 0!==event.pageX&&void 0!==event.pageY&&(this.__startMousePosition.left=event.pageX,this.__startMousePosition.top=event.pageY,this.__startMousePositionCopyMoveOffsetPosition.left=0,this.__startMousePositionCopyMoveOffsetPosition.top=0,activeControl?.jOriginalPosition)){const untransformedBBox=activeControl.jOriginalPosition[0].getBoundingClientRect();this.__positionInsideControl.top=event.pageY-untransformedBBox.top-window.scrollY,this.__positionInsideControl.left=event.pageX-untransformedBBox.left-window.scrollX,this.__positionInsideControl.height=untransformedBBox.height,this.__positionInsideControl.width=untransformedBBox.width}}handleInteractionStartCopyMoveOffsetPosition(event){void 0!==event.pageX&&void 0!==event.pageY&&(this.__startMousePositionCopyMoveOffsetPosition.left=event.pageX,this.__startMousePositionCopyMoveOffsetPosition.top=event.pageY)}refreshControlSnapPositionCache(ctrlMeta){if(designerModeManager.getSettings().enableSnapping){if(!ctrlMeta){const controlsMetaData=metaDataManager.getControlMetaData();for(const ctrlMeta of controlsMetaData.values())this.refreshControlSnapPositionCache(ctrlMeta);return}if(0===ctrlMeta.absoluteParentRotation&&(this.__addPositionCacheEntry(ctrlMeta.jOriginalPosition[0],ctrlMeta.id,ctrlMeta.isContainerControl),ctrlMeta.isGridControl)){let allGridCells=ctrlMeta.jControlPosition.children(".tchmi-creator-gridcell");for(let i=0,ii=allGridCells.length;i<ii;i++)this.__addPositionCacheEntry(allGridCells[i],ctrlMeta.id,!0)}}}__addSnapPosition(cache,newEntry,key){cache[key]?cache[key].push(newEntry):cache[key]=[newEntry]}__addPositionCacheEntry(htmlElem,name,isContainer){const creatorZoomFactor=rootControlManager?.getCreatorZoomFactor()??1,designerSettings=designerModeManager.getSettings(),controlDistance=designerSettings.snapDistanceToControls*creatorZoomFactor,containerInnerDistance=controlDistance,untransformedBBox=htmlElem.getBoundingClientRect(),left=Math.round(untransformedBBox.left+window.scrollX),top=Math.round(untransformedBBox.top+window.scrollY),right=Math.round(untransformedBBox.right+window.scrollX),bottom=Math.round(untransformedBBox.bottom+window.scrollY);designerSettings.snapToControls&&(this.__addSnapPosition(this.__verPositionCache,{name,controlTopOrLeft:!0,remoteMatch:!1},top),this.__addSnapPosition(this.__verPositionCache,{name,controlTopOrLeft:!0,remoteMatch:!0},top-controlDistance)),isContainer&&designerSettings.snapToInnerContainerSides&&this.__addSnapPosition(this.__verPositionCache,{name,controlTopOrLeft:!1,remoteMatch:!0},top+containerInnerDistance),designerSettings.snapToControls&&(this.__addSnapPosition(this.__verPositionCache,{name,controlTopOrLeft:!1,remoteMatch:!1},bottom),this.__addSnapPosition(this.__verPositionCache,{name,controlTopOrLeft:!1,remoteMatch:!0},bottom+controlDistance)),isContainer&&designerSettings.snapToInnerContainerSides&&this.__addSnapPosition(this.__verPositionCache,{name,controlTopOrLeft:!0,remoteMatch:!0},bottom-containerInnerDistance),designerSettings.snapToControls&&(this.__addSnapPosition(this.__horPositionCache,{name,controlTopOrLeft:!0,remoteMatch:!1},left),this.__addSnapPosition(this.__horPositionCache,{name,controlTopOrLeft:!0,remoteMatch:!0},left-controlDistance)),isContainer&&designerSettings.snapToInnerContainerSides&&this.__addSnapPosition(this.__horPositionCache,{name,controlTopOrLeft:!1,remoteMatch:!0},left+containerInnerDistance),designerSettings.snapToControls&&(this.__addSnapPosition(this.__horPositionCache,{name,controlTopOrLeft:!1,remoteMatch:!1},right),this.__addSnapPosition(this.__horPositionCache,{name,controlTopOrLeft:!1,remoteMatch:!0},right+controlDistance)),isContainer&&designerSettings.snapToInnerContainerSides&&this.__addSnapPosition(this.__horPositionCache,{name,controlTopOrLeft:!0,remoteMatch:!0},right-containerInnerDistance)}handleSnapping(ctrlMeta,mouseDelta,mousePos,snapControls,directionLock){let deltaCorrectionLeft=0,deltaCorrectionTop=0;const creatorZoomFactor=rootControlManager?.getCreatorZoomFactor()??1;let controlSnappedTop="topBottom"===directionLock,controlSnappedBottom="topBottom"===directionLock,controlSnappedLeft="leftRight"===directionLock,controlSnappedRight="leftRight"===directionLock,controlSnappedTopRemoteMatch=!1,controlSnappedBottomRemoteMatch=!1,controlSnappedLeftRemoteMatch=!1,controlSnappedRightRemoteMatch=!1;if(snapControls&&0===ctrlMeta.absoluteParentRotation){const selectedControlIds=metaDataManager.getSelectedControlIdsWithChildren();let controlSnappointInViewportPixelStr,controlSnappointInViewportPixel,snapAtTop="topBottom"!==directionLock,snapAtBottom="topBottom"!==directionLock,snapAtLeft="leftRight"!==directionLock,snapAtRight="leftRight"!==directionLock;switch(this.__anchorName){case"TopLeft":snapAtBottom=!1,snapAtRight=!1;break;case"TopCenter":snapAtBottom=!1,snapAtLeft=!1,snapAtRight=!1;break;case"TopRight":snapAtBottom=!1,snapAtLeft=!1;break;case"CenterRight":snapAtTop=!1,snapAtBottom=!1,snapAtLeft=!1;break;case"CenterLeft":snapAtTop=!1,snapAtBottom=!1,snapAtRight=!1;break;case"BottomLeft":snapAtTop=!1,snapAtRight=!1;break;case"BottomCenter":snapAtTop=!1,snapAtLeft=!1,snapAtRight=!1;break;case"BottomRight":snapAtTop=!1,snapAtLeft=!1}if(snapAtTop||snapAtBottom)for(controlSnappointInViewportPixelStr in this.__verPositionCache){let snappedControlInfoArray=this.__verPositionCache[controlSnappointInViewportPixelStr];if(controlSnappointInViewportPixel=parseInt(controlSnappointInViewportPixelStr,10),!isNaN(controlSnappointInViewportPixel))if(snapAtTop&&controlSnappointInViewportPixel-5<mousePos.top-this.__positionInsideControl.top&&mousePos.top-this.__positionInsideControl.top<controlSnappointInViewportPixel+5){for(let snappedControlInfo of snappedControlInfoArray)if(!(selectedControlIds.includes(snappedControlInfo.name)||snappedControlInfo.remoteMatch&&snappedControlInfo.controlTopOrLeft)){controlSnappedTop||controlSnappedBottom?controlSnappointInViewportPixel-deltaCorrectionTop===mousePos.top-this.__positionInsideControl.top&&(controlSnappedTop=!0,controlSnappedTopRemoteMatch=snappedControlInfo.remoteMatch):(deltaCorrectionTop=controlSnappointInViewportPixel-(mousePos.top-this.__positionInsideControl.top),controlSnappedTop=!0,controlSnappedTopRemoteMatch=snappedControlInfo.remoteMatch);break}}else if(snapAtBottom&&controlSnappointInViewportPixel-5<mousePos.top-this.__positionInsideControl.top+this.__positionInsideControl.height&&mousePos.top-this.__positionInsideControl.top+this.__positionInsideControl.height<controlSnappointInViewportPixel+5)for(let snappedControlInfo of snappedControlInfoArray)if(!selectedControlIds.includes(snappedControlInfo.name)&&(!snappedControlInfo.remoteMatch||snappedControlInfo.controlTopOrLeft)){controlSnappedTop||controlSnappedBottom?controlSnappointInViewportPixel-deltaCorrectionTop===mousePos.top-this.__positionInsideControl.top+this.__positionInsideControl.height&&(controlSnappedBottom=!0,controlSnappedBottomRemoteMatch=snappedControlInfo.remoteMatch):(deltaCorrectionTop=controlSnappointInViewportPixel-(mousePos.top-this.__positionInsideControl.top+this.__positionInsideControl.height),controlSnappedBottom=!0,controlSnappedBottomRemoteMatch=snappedControlInfo.remoteMatch);break}if(controlSnappedTop&&controlSnappedBottom)break}if(snapAtLeft||snapAtRight)for(controlSnappointInViewportPixelStr in this.__horPositionCache){let snappedControlInfoArray=this.__horPositionCache[controlSnappointInViewportPixelStr];if(controlSnappointInViewportPixel=parseInt(controlSnappointInViewportPixelStr,10),!isNaN(controlSnappointInViewportPixel))if(snapAtLeft&&controlSnappointInViewportPixel-5<mousePos.left-this.__positionInsideControl.left&&mousePos.left-this.__positionInsideControl.left<controlSnappointInViewportPixel+5){for(let snappedControlInfo of snappedControlInfoArray)if(!(selectedControlIds.includes(snappedControlInfo.name)||snappedControlInfo.remoteMatch&&snappedControlInfo.controlTopOrLeft)){controlSnappedLeft||controlSnappedRight?controlSnappointInViewportPixel-deltaCorrectionLeft===mousePos.left-this.__positionInsideControl.left&&(controlSnappedLeft=!0,controlSnappedLeftRemoteMatch=snappedControlInfo.remoteMatch):(deltaCorrectionLeft=controlSnappointInViewportPixel-(mousePos.left-this.__positionInsideControl.left),controlSnappedLeft=!0,controlSnappedLeftRemoteMatch=snappedControlInfo.remoteMatch);break}}else if(snapAtRight&&controlSnappointInViewportPixel-5<mousePos.left-this.__positionInsideControl.left+this.__positionInsideControl.width&&mousePos.left-this.__positionInsideControl.left+this.__positionInsideControl.width<controlSnappointInViewportPixel+5)for(let snappedControlInfo of snappedControlInfoArray)if(!selectedControlIds.includes(snappedControlInfo.name)&&(!snappedControlInfo.remoteMatch||snappedControlInfo.controlTopOrLeft)){controlSnappedLeft||controlSnappedRight?controlSnappointInViewportPixel-deltaCorrectionLeft===mousePos.left-this.__positionInsideControl.left+this.__positionInsideControl.width&&(controlSnappedRight=!0,controlSnappedRightRemoteMatch=snappedControlInfo.remoteMatch):(deltaCorrectionLeft=controlSnappointInViewportPixel-(mousePos.left-this.__positionInsideControl.left+this.__positionInsideControl.width),controlSnappedRight=!0,controlSnappedRightRemoteMatch=snappedControlInfo.remoteMatch);break}if(controlSnappedLeft&&controlSnappedRight)break}}return ctrlMeta.jOriginalPosition[0].classList.toggle("tchmi-creator-control-snaptop",controlSnappedTop),ctrlMeta.jOriginalPosition[0].classList.toggle("tchmi-creator-control-snapbottom",controlSnappedBottom),ctrlMeta.jOriginalPosition[0].classList.toggle("tchmi-creator-control-snapleft",controlSnappedLeft),ctrlMeta.jOriginalPosition[0].classList.toggle("tchmi-creator-control-snapright",controlSnappedRight),ctrlMeta.jOriginalPosition[0].classList.toggle("tchmi-creator-control-snaptop-remote",controlSnappedTopRemoteMatch),ctrlMeta.jOriginalPosition[0].classList.toggle("tchmi-creator-control-snapbottom-remote",controlSnappedBottomRemoteMatch),ctrlMeta.jOriginalPosition[0].classList.toggle("tchmi-creator-control-snapleft-remote",controlSnappedLeftRemoteMatch),ctrlMeta.jOriginalPosition[0].classList.toggle("tchmi-creator-control-snapright-remote",controlSnappedRightRemoteMatch),{left:mouseDelta.left+deltaCorrectionLeft/creatorZoomFactor,top:mouseDelta.top+deltaCorrectionTop/creatorZoomFactor}}__handleDesignerWheelEvents(event){if(event.ctrlKey&&0!==event.deltaY&&rootControlManager){let oldZoom=rootControlManager.getCreatorZoomFactor();const zoomSteps=designerModeManager.getSettings().scaleFactors??[.1,.2,.3,.4,.5,.6,.7,.8,.9,1,1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2,2.1,2.2,2.3,2.4,2.5,2.6,2.7,2.8,2.9,3,3.1,3.2,3.3,3.4,3.5,3.6,3.7,3.8,3.9,4];let newZoom,oldIndex=zoomSteps.indexOf(oldZoom);newZoom=event.deltaY<0?zoomSteps[oldIndex+1]??zoomSteps[zoomSteps.length-1]:zoomSteps[oldIndex-1]??zoomSteps[0],rootControlManager.setCreatorZoom(newZoom);const cmd={name:"Zoom",factor:newZoom,targetPartial:TCHMI_TARGET_PARTIAL,frameworkType:"Designer",replyTo:null};new SyncCmdToCreatorZoom(cmd).send(),event.preventDefault()}}}})();export{DesignerModeMasterInteractionManager};export const interactionManager=new DesignerModeMasterInteractionManager;