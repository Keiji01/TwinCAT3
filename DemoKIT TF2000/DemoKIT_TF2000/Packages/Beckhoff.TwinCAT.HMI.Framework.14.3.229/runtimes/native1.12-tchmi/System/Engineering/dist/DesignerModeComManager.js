var __runInitializers=this&&this.__runInitializers||function(thisArg,initializers,value){for(var useValue=arguments.length>2,i=0;i<initializers.length;i++)value=useValue?initializers[i].call(thisArg,value):initializers[i].call(thisArg);return useValue?value:void 0},__esDecorate=this&&this.__esDecorate||function(ctor,descriptorIn,decorators,contextIn,initializers,extraInitializers){function accept(f){if(void 0!==f&&"function"!=typeof f)throw new TypeError("Function expected");return f}for(var _,kind=contextIn.kind,key="getter"===kind?"get":"setter"===kind?"set":"value",target=!descriptorIn&&ctor?contextIn.static?ctor:ctor.prototype:null,descriptor=descriptorIn||(target?Object.getOwnPropertyDescriptor(target,contextIn.name):{}),done=!1,i=decorators.length-1;i>=0;i--){var context={};for(var p in contextIn)context[p]="access"===p?{}:contextIn[p];for(var p in contextIn.access)context.access[p]=contextIn.access[p];context.addInitializer=function(f){if(done)throw new TypeError("Cannot add initializers after decoration has completed");extraInitializers.push(accept(f||null))};var result=(0,decorators[i])("accessor"===kind?{get:descriptor.get,set:descriptor.set}:descriptor[key],context);if("accessor"===kind){if(void 0===result)continue;if(null===result||"object"!=typeof result)throw new TypeError("Object expected");(_=accept(result.get))&&(descriptor.get=_),(_=accept(result.set))&&(descriptor.set=_),(_=accept(result.init))&&initializers.unshift(_)}else(_=accept(result))&&("field"===kind?initializers.unshift(_):descriptor[key]=_)}target&&Object.defineProperty(target,contextIn.name,descriptor),done=!0};import{SyncCmdToFrameworkCurrentPartialContent}from"./SyncCmdToFrameworkCurrentPartialContent.js";import{SyncCmdToFrameworkCurrentPartialContents}from"./SyncCmdToFrameworkCurrentPartialContents.js";import{SyncCmdToFrameworkTcHmiConfigChanged}from"./SyncCmdToFrameworkTcHmiConfigChanged.js";import{SyncCmdToFrameworkPartialEditorLocked}from"./SyncCmdToFrameworkPartialEditorLocked.js";import{SyncCmdToFrameworkLogoutClient}from"./SyncCmdToFrameworkLogoutClient.js";import{SyncCmdToCreatorRegisterSyncView}from"./SyncCmdToCreatorRegisterSyncView.js";import{SyncCmdToFrameworkCurrentPartialEditorLockState}from"./SyncCmdToFrameworkCurrentPartialEditorLockState.js";import{SyncCmdToFrameworkPartialEditorUnlocked}from"./SyncCmdToFrameworkPartialEditorUnlocked.js";import{SyncCmdToFrameworkSyncViewRegistered}from"./SyncCmdToFrameworkSyncViewRegistered.js";import{supportedCommandFromFramework}from"./SyncCmdToFramework.js";let SyncCmdToFrameworkRequestDropControlPosition,SyncCmdToFrameworkSelectedControls,SyncCmdToFrameworkScrollPositionChanged,SyncCmdToFrameworkSyncControls,SyncCmdToFrameworkKeyStates,SyncCmdToFrameworkDomVisibility,SyncCmdToFrameworkCurrentPartialHighlightContainerState,SyncCmdToFrameworkZoom,SyncCmdToFrameworkCreateControls,SyncCmdToFrameworkRemoveControls,SyncCmdToFrameworkServerAddress,SyncCmdToFrameworkDesignerSettings,SyncCmdToFrameworkControlLocked;TCHMI_DESIGNER&&(import("./SyncCmdToFrameworkRequestDropControlPosition.js").then(module=>{SyncCmdToFrameworkRequestDropControlPosition=module.SyncCmdToFrameworkRequestDropControlPosition}),import("./SyncCmdToFrameworkSelectedControls.js").then(module=>{SyncCmdToFrameworkSelectedControls=module.SyncCmdToFrameworkSelectedControls}),import("./SyncCmdToFrameworkScrollPositionChanged.js").then(module=>{SyncCmdToFrameworkScrollPositionChanged=module.SyncCmdToFrameworkScrollPositionChanged}),import("./SyncCmdToFrameworkSyncControls.js").then(module=>{SyncCmdToFrameworkSyncControls=module.SyncCmdToFrameworkSyncControls}),import("./SyncCmdToFrameworkKeyStates.js").then(module=>{SyncCmdToFrameworkKeyStates=module.SyncCmdToFrameworkKeyStates}),import("./SyncCmdToFrameworkDomVisibility.js").then(module=>{SyncCmdToFrameworkDomVisibility=module.SyncCmdToFrameworkDomVisibility}),import("./SyncCmdToFrameworkCurrentPartialHighlightContainerState.js").then(module=>{SyncCmdToFrameworkCurrentPartialHighlightContainerState=module.SyncCmdToFrameworkCurrentPartialHighlightContainerState}),import("./SyncCmdToFrameworkZoom.js").then(module=>{SyncCmdToFrameworkZoom=module.SyncCmdToFrameworkZoom}),import("./SyncCmdToFrameworkCreateControls.js").then(module=>{SyncCmdToFrameworkCreateControls=module.SyncCmdToFrameworkCreateControls}),import("./SyncCmdToFrameworkRemoveControls.js").then(module=>{SyncCmdToFrameworkRemoveControls=module.SyncCmdToFrameworkRemoveControls}),import("./SyncCmdToFrameworkServerAddress.js").then(module=>{SyncCmdToFrameworkServerAddress=module.SyncCmdToFrameworkServerAddress}),import("./SyncCmdToFrameworkDesignerSettings.js").then(module=>{SyncCmdToFrameworkDesignerSettings=module.SyncCmdToFrameworkDesignerSettings}),import("./SyncCmdToFrameworkControlLocked.js").then(module=>{SyncCmdToFrameworkControlLocked=module.SyncCmdToFrameworkControlLocked}));import{designerModeManager}from"./DesignerModeManager.js";let DesignerModeComManager=(()=>{var _a,_b,_c,_d;let ___onDisableCommunication_decorators,___connectionWatcherTick_decorators,___websocketOnClose_decorators,___websocketOnMessage_decorators,_instanceExtraInitializers=[];return class DesignerModeComManager{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;___onDisableCommunication_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],___connectionWatcherTick_decorators=[(_b=TcHmi).CallbackMethod.bind(_b)],___websocketOnClose_decorators=[(_c=TcHmi).CallbackMethod.bind(_c)],___websocketOnMessage_decorators=[(_d=TcHmi).CallbackMethod.bind(_d)],__esDecorate(this,null,___onDisableCommunication_decorators,{kind:"method",name:"__onDisableCommunication",static:!1,private:!1,access:{has:obj=>"__onDisableCommunication"in obj,get:obj=>obj.__onDisableCommunication},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___connectionWatcherTick_decorators,{kind:"method",name:"__connectionWatcherTick",static:!1,private:!1,access:{has:obj=>"__connectionWatcherTick"in obj,get:obj=>obj.__connectionWatcherTick},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___websocketOnClose_decorators,{kind:"method",name:"__websocketOnClose",static:!1,private:!1,access:{has:obj=>"__websocketOnClose"in obj,get:obj=>obj.__websocketOnClose},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___websocketOnMessage_decorators,{kind:"method",name:"__websocketOnMessage",static:!1,private:!1,access:{has:obj=>"__websocketOnMessage"in obj,get:obj=>obj.__websocketOnMessage},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}constructor(){TcHmi.EventProvider.register("System.disableCommunication",this.__onDisableCommunication);const lsReconCount=window.localStorage.getItem(TcHmi.System.hostPrefix+"TcHmi.System.Engineering.DesignerModeComManager.reconnectCount")??"0";this.__globalReconnectCount=parseInt(lsReconCount,10),this.initializedTwowayCommunication=new Promise(resolve=>{this.__resolveInitializedTwowayCommunication=resolve}),TCHMI_ENGINEERING_WEBSOCKET&&this.fillSupportedCommandFromVS(["ControlDoubleClick","CopyMoveControls","DropControlPosition","HierarchyMoveControls","Messages","RegisterSyncView","RequestCurrentPartialContent","RequestRequiredViewPortSize","SelectedControls","SyncControls","Zoom"])}__resolveInitializedTwowayCommunication=__runInitializers(this,_instanceExtraInitializers);initializedTwowayCommunication;__websocket=void 0;__websocketWasClosedUnexpected=!1;__connectionWatcherInterval=0;__unloaded=!1;supportedCommandFromVS=[];fillSupportedCommandFromVS(cmds){this.supportedCommandFromVS=cmds,this.__resolveInitializedTwowayCommunication()}static RECONNECT_INTERVAL=5e3;__globalReconnectCount=0;__onDisableCommunication(_event){this.__unloaded=!0,this.__websocket&&(this.__websocket.close(),this.__websocket=void 0)}__connectionWatcherTick(){void 0===this.__websocket&&this.open()}__handleSyncCommandMessageResponse(messageObj){if(!messageObj.command)return;let commandHandler,checkDesignerLock=!0;switch(TCHMI_LOG_ENGINEERING_COM_MESSAGES&&TcHmi.Log.debugEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeComManager] Received command %o to TwinCAT HMI Engineering (timestamp %o): %o",messageObj.command.name,messageObj.timestamp,messageObj.command),messageObj.command.name){case"Messages":default:break;case"Confirmation":case"TransactionBegin":case"TransactionCommit":case"InjectResources":return;case"ScrollPositionChanged":if(checkDesignerLock=!1,!SyncCmdToFrameworkScrollPositionChanged)return void(TCHMI_DESIGNER&&TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Internal error: SyncCmdToFrameworkScrollPositionChanged not loaded"));commandHandler=new SyncCmdToFrameworkScrollPositionChanged(messageObj.command);break;case"RequestDropControlPosition":if(!SyncCmdToFrameworkRequestDropControlPosition)return void(TCHMI_DESIGNER&&TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Internal error: SyncCmdToFrameworkRequestDropControlPosition not loaded"));commandHandler=new SyncCmdToFrameworkRequestDropControlPosition(messageObj.command);break;case"CreateControls":if(!SyncCmdToFrameworkCreateControls)return void(TCHMI_DESIGNER&&TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Internal error: SyncCmdToFrameworkCreateControls not loaded"));commandHandler=new SyncCmdToFrameworkCreateControls(messageObj.command);break;case"SyncControls":if(!SyncCmdToFrameworkSyncControls)return void(TCHMI_DESIGNER&&TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Internal error: SyncCmdToFrameworkSyncControls not loaded"));commandHandler=new SyncCmdToFrameworkSyncControls(messageObj.command);break;case"RemoveControls":if(!SyncCmdToFrameworkRemoveControls)return void(TCHMI_DESIGNER&&TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Internal error: SyncCmdToFrameworkRemoveControls not loaded"));commandHandler=new SyncCmdToFrameworkRemoveControls(messageObj.command);break;case"SelectedControls":if(!SyncCmdToFrameworkSelectedControls)return void(TCHMI_DESIGNER&&TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Internal error: SyncCmdToFrameworkSelectedControls not loaded"));commandHandler=new SyncCmdToFrameworkSelectedControls(messageObj.command);break;case"ServerAddress":if(!SyncCmdToFrameworkServerAddress)return void(TCHMI_DESIGNER&&TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Internal error: SyncCmdToFrameworkServerAddress not loaded"));checkDesignerLock=!1,commandHandler=new SyncCmdToFrameworkServerAddress(messageObj.command);break;case"DesignerSettings":if(!SyncCmdToFrameworkDesignerSettings)return void(TCHMI_DESIGNER&&TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Internal error: SyncCmdToFrameworkDesignerSettings not loaded"));commandHandler=new SyncCmdToFrameworkDesignerSettings(messageObj.command);break;case"SyncViewRegistered":this.__globalReconnectCount&&(window.localStorage.removeItem(TcHmi.System.hostPrefix+"TcHmi.System.Engineering.DesignerModeComManager.reconnectCount"),this.__globalReconnectCount=0),commandHandler=new SyncCmdToFrameworkSyncViewRegistered(messageObj.command);break;case"DomVisibility":if(!SyncCmdToFrameworkDomVisibility)return void(TCHMI_DESIGNER&&TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Internal error: SyncCmdToFrameworkDomVisibility not loaded"));commandHandler=new SyncCmdToFrameworkDomVisibility(messageObj.command);break;case"ControlLocked":if(!SyncCmdToFrameworkControlLocked)return void(TCHMI_DESIGNER&&TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Internal error: SyncCmdToFrameworkControlLocked not loaded"));commandHandler=new SyncCmdToFrameworkControlLocked(messageObj.command);break;case"KeyStates":if(!SyncCmdToFrameworkKeyStates)return void(TCHMI_DESIGNER&&TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Internal error: SyncCmdToFrameworkKeyStates not loaded"));checkDesignerLock=!1,commandHandler=new SyncCmdToFrameworkKeyStates(messageObj.command);break;case"CurrentPartialContent":this.__globalReconnectCount&&(window.localStorage.removeItem(TcHmi.System.hostPrefix+"TcHmi.System.Engineering.DesignerModeComManager.reconnectCount"),this.__globalReconnectCount=0),commandHandler=new SyncCmdToFrameworkCurrentPartialContent(messageObj.command);break;case"CurrentPartialContents":this.__globalReconnectCount&&(window.localStorage.removeItem(TcHmi.System.hostPrefix+"TcHmi.System.Engineering.DesignerModeComManager.reconnectCount"),this.__globalReconnectCount=0),commandHandler=new SyncCmdToFrameworkCurrentPartialContents(messageObj.command);break;case"TcHmiConfigChanged":commandHandler=new SyncCmdToFrameworkTcHmiConfigChanged(messageObj.command);break;case"Zoom":if(!SyncCmdToFrameworkZoom)return void(TCHMI_DESIGNER&&TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Internal error: SyncCmdToFrameworkZoom not loaded"));checkDesignerLock=!1,commandHandler=new SyncCmdToFrameworkZoom(messageObj.command);break;case"PartialEditorLocked":checkDesignerLock=!1,commandHandler=new SyncCmdToFrameworkPartialEditorLocked(messageObj.command);break;case"PartialEditorUnlocked":checkDesignerLock=!1,commandHandler=new SyncCmdToFrameworkPartialEditorUnlocked(messageObj.command);break;case"CurrentPartialEditorLockState":commandHandler=new SyncCmdToFrameworkCurrentPartialEditorLockState(messageObj.command);break;case"CurrentPartialHighlightContainerState":if(!SyncCmdToFrameworkCurrentPartialHighlightContainerState)return void(TCHMI_DESIGNER&&TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeManager] Internal error: SyncCmdToFrameworkCurrentPartialHighlightContainerState not loaded"));commandHandler=new SyncCmdToFrameworkCurrentPartialHighlightContainerState(messageObj.command);break;case"LogoutClient":commandHandler=new SyncCmdToFrameworkLogoutClient(messageObj.command)}if(!checkDesignerLock||!designerModeManager.isLocked())if(void 0!==commandHandler)try{commandHandler.run()}catch(e){TcHmi.Log.errorEx(`[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeComManager] An uncaught exception occurred while performing "${messageObj.command.name}" command:\n`,e)}else TcHmi.Log.warn('[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeComManager] Command "'+messageObj.command.name+'" not implemented.')}__createWebsocketOnOpenHandler(callback){return _openEvent=>{if(TcHmi.Log.debug(`[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeComManager] WebSocket with url=${this.__websocket.url} opened.`),this.__websocket){if(this.__websocketWasClosedUnexpected)return TCHMI_DESIGNER?void window.location.reload():(TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_WEBSOCKET_NOT_READY,details:{code:TcHmi.Errors.E_WEBSOCKET_NOT_READY,message:TcHmi.Errors[TcHmi.Errors.E_WEBSOCKET_NOT_READY],domain:"TcHmi.System.Engineering.DesignerModeComManager"}}),TcHmi.System.Services.dialogManager.showDialog("__DesignerModeComManager",!1,TcHmi.DialogManager.DialogType.Overlay,{force:!0}),this.__globalReconnectCount<=2?(TcHmi.System.Services.dialogManager.updateTextEx("__DesignerModeComManager",TcHmi.System.Services.localization.getText("Engineering_Websocket_Restored",{level:TcHmi.Locale.Level.Engineering})+" "+tchmi_format_string(TcHmi.System.Services.localization.getText("Reload_In_N_Seconds",{level:TcHmi.Locale.Level.Engineering}),5),{severity:TcHmi.DialogManager.DialogSeverity.Warning,buttonReload:!TCHMI_DESIGNER}),setTimeout(()=>{window.location.reload()},5e3)):TcHmi.System.Services.dialogManager.updateTextEx("__DesignerModeComManager",TcHmi.System.Services.localization.getText("Engineering_Websocket_Rejected",{level:TcHmi.Locale.Level.Engineering})+(document.cookie.length<15e3?"":"<br>"+TcHmi.System.Services.localization.getText("Engineering_Websocket_Large_Cookie",{level:TcHmi.Locale.Level.Engineering})),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),void TcHmi.System.Services.dialogManager.showDialog("__DesignerModeComManager",!0,TcHmi.DialogManager.DialogType.Overlay));new SyncCmdToCreatorRegisterSyncView({name:"RegisterSyncView",targetPartial:TCHMI_TARGET_PARTIAL,targetInstance:TCHMI_DYNAMIC_INSTANCE_ID,syncViewLevel:TCHMI_DESIGNER?"Master":"Slave",supportedCommands:supportedCommandFromFramework,sessionId:TcHmi.System.Services.accessManager.getCurrentUserConfig().session??"",replyTo:null}).send(),-1===TCHMI_CONSOLE_LOG_LEVEL&&performance.mark("System.DesignerModeComManager: RegisterSyncView"),TcHmi.System.promiseTimeout(designerModeComManager.initializedTwowayCommunication,{rejectMessage:"Did not got designer answer in time"}).then(()=>{TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE})}).catch(error=>(TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModePartialContentManager] DesignerModeComManager not initialized in time.",error),TcHmi.Callback.callSafeEx(callback,null,{error:error instanceof TcHmi.Exception?error.code:TcHmi.Errors.E_EXCEPTION,details:error instanceof TcHmi.Exception?error.details:void 0}),Promise.reject(error)))}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_WEBSOCKET_NOT_READY,details:{code:TcHmi.Errors.E_WEBSOCKET_NOT_READY,message:TcHmi.Errors[TcHmi.Errors.E_WEBSOCKET_NOT_READY],domain:"TcHmi.System.Engineering.DesignerModeComManager"}})}}__websocketOnClose(closeEvent){if(this.__unloaded||!this.__websocket)return;try{const lsReconCount=window.localStorage.getItem(TcHmi.System.hostPrefix+"TcHmi.System.Engineering.DesignerModeComManager.reconnectCount")??"0";this.__globalReconnectCount=parseInt(lsReconCount,10)+1,window.localStorage.setItem(TcHmi.System.hostPrefix+"TcHmi.System.Engineering.DesignerModeComManager.reconnectCount",this.__globalReconnectCount.toString())}catch(ex){}this.__websocketWasClosedUnexpected=!0;let message=`[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeComManager] WebSocket with url=${this.__websocket.url} was closed`;closeEvent.code&&(message+=" with code="+closeEvent.code),closeEvent.reason&&(message+=" and reason="+closeEvent.reason),message+=".",TcHmi.Log.error(message),this.__websocket=void 0,window.clearInterval(this.__connectionWatcherInterval),this.__connectionWatcherInterval=window.setInterval(this.__connectionWatcherTick,DesignerModeComManager.RECONNECT_INTERVAL),TcHmi.System.Services.dialogManager.showDialog("__DesignerModeComManager",!1,TcHmi.DialogManager.DialogType.Overlay,{force:!0}),TcHmi.System.Services.dialogManager.updateTextEx("__DesignerModeComManager",TcHmi.System.Services.localization.getText("Engineering_Websocket_Lost",{level:TcHmi.Locale.Level.Engineering}),{severity:TcHmi.DialogManager.DialogSeverity.Warning,buttonReload:!TCHMI_DESIGNER}),TcHmi.System.Services.dialogManager.showDialog("__DesignerModeComManager",!0,TcHmi.DialogManager.DialogType.Overlay)}__websocketOnMessage(messageEvent){if(this.__unloaded)return;if(void 0===messageEvent)return;if(void 0===messageEvent.data)return;const messageObj=TcHmi.ValueConverter.toObject(messageEvent.data);null!==messageObj&&messageObj.command?this.__handleSyncCommandMessageResponse(messageObj):TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeComManager] Failed to parse JSON message from TwinCAT HMI Creator (Visual Studio Engineering)!",{messageObj})}open(callback){if(!TCHMI_ENGINEERING_WEBSOCKET)return TcHmi.Server.Events.registerConsumer([{comparator:"==",path:"domain",value:"TcHmiSrv"},{logic:"AND"},{comparator:"==",path:"name",value:"ENGINEERING_CREATOR_COMMAND"}],{subscription:data=>{data.event&&TcHmi.Server.Events.isPayload(data.event)&&data.event.payload&&this.__handleSyncCommandMessageResponse(data.event.payload)}}),TcHmi.Server.Events.flushRegistrations(),new SyncCmdToCreatorRegisterSyncView({name:"RegisterSyncView",targetPartial:TCHMI_TARGET_PARTIAL,targetInstance:TCHMI_DYNAMIC_INSTANCE_ID,syncViewLevel:TCHMI_DESIGNER?"Master":"Slave",supportedCommands:supportedCommandFromFramework,sessionId:TcHmi.System.Services.accessManager.getCurrentUserConfig().session??"",replyTo:null}).send(),-1===TCHMI_CONSOLE_LOG_LEVEL&&performance.mark("System.DesignerModeComManager: RegisterSyncView"),void TcHmi.System.promiseTimeout(designerModeComManager.initializedTwowayCommunication,{rejectMessage:"Did not got designer answer in time"}).then(()=>{TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE})}).catch(error=>(TcHmi.Log.errorEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModePartialContentManager] DesignerModeComManager not initialized in time.",error),TcHmi.Callback.callSafeEx(callback,null,{error:error instanceof TcHmi.Exception?error.code:TcHmi.Errors.E_EXCEPTION,details:error instanceof TcHmi.Exception?error.details:void 0}),Promise.reject(error)));if(this.__unloaded)TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.System.Engineering.DesignerModeComManager",reason:"Website already unloaded."}});else if(!this.__websocket){try{this.__websocket=new WebSocket(TCHMI_ENGINEERING_WEBSOCKET+"/DesignerWebsocketname="+TCHMI_ENGINEERING_WEBSOCKET)}catch(ex){let reason="Opening connection to TwinCAT HMI Creator (Visual Studio Engineering) failed";if(ex instanceof DOMException&&(reason+=": "+ex.message),callback)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],domain:"TcHmi.System.Engineering.DesignerModeComManager",reason}});throw TcHmi.Log.error("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeComManager] "+reason),new Error(reason)}this.__websocket.onopen=this.__createWebsocketOnOpenHandler(callback),this.__websocket.onclose=this.__websocketOnClose,this.__websocket.onmessage=this.__websocketOnMessage,setTimeout(()=>{this.__websocket?.readyState!==WebSocket.OPEN&&TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_TIMEOUT,details:{code:TcHmi.Errors.E_TIMEOUT,message:TcHmi.Errors[TcHmi.Errors.E_TIMEOUT],reason:"TwinCAT HMI Creator (Visual Studio Engineering) Websocket did not respond within expected time.",domain:"TcHmi.System.Engineering.DesignerModeComManager"}})},3e4)}}sendCommand(cmd,timestamp){const messageObj={command:cmd,id:tchmi_create_guid(),timestamp:timestamp??Date.now()};if(TCHMI_LOG_ENGINEERING_COM_MESSAGES&&TcHmi.Log.debugEx("[Source=Framework, Module=TcHmi.System.Engineering.DesignerModeComManager] Sending command %o to TwinCAT HMI Engineering (timestamp %o): %o",messageObj.command.name,messageObj.timestamp,cmd),TCHMI_ENGINEERING_WEBSOCKET){if(void 0!==this.__websocket&&this.__websocket.readyState===WebSocket.OPEN){const message=JSON.stringify(messageObj);this.__websocket.send(message)}}else TcHmi.Server.Events.createEvent({domain:"TcHmiSrv",name:"ENGINEERING_FRAMEWORK_COMMAND",payload:messageObj,type:TcHmi.Server.Events.Type.Payload,timeReceived:new Date},data=>{data.error&&TcHmi.Log.errorEx("Sending Designer message via Server Event failed: ",TcHmi.Log.buildMessage(data.details))})}}})();export{DesignerModeComManager};export const designerModeComManager=new DesignerModeComManager;