"use strict";!function(TcHmi){!function(Controls){!function(Helpers){Helpers.Display=class{__element;__parentControl;__suspended=!0;__autoSuspended=!1;__directory=null;__directoryEventDestroyers=[];__parentControlEventDestroyers=[];constructor(__element,__parentControl){this.__element=__element,this.__parentControl=__parentControl,this.__parentControlEventDestroyers.push(TcHmi.EventProvider.register(this.__parentControl.getId()+".onDetached",()=>{this.__suspended||(this.suspend(!0),this.__autoSuspended=!0)}),TcHmi.EventProvider.register(this.__parentControl.getId()+".onAttached",()=>{this.__autoSuspended&&(this.resume(),this.__autoSuspended=!1)}),TcHmi.EventProvider.register(this.__parentControl.getId()+".onDestroyed",()=>{this.suspend(!0);for(let destroyer of this.__parentControlEventDestroyers)destroyer();this.__parentControlEventDestroyers=[]}))}suspend(clear){if(!this.__suspended){for(const destroy of this.__directoryEventDestroyers)destroy();this.__directoryEventDestroyers=[],this.__suspended=!0}}resume(){this.__suspended&&(this.__suspended=!1)}setDirectory(directory){for(const destroy of this.__directoryEventDestroyers)destroy();this.__directoryEventDestroyers=[],this.__directory=directory,this.__processDirectory()}}}(Controls.Helpers||(Controls.Helpers={}))}(TcHmi.Controls||(TcHmi.Controls={}))}(TcHmi||(TcHmi={}));var TcHmi,__runInitializers=this&&this.__runInitializers||function(thisArg,initializers,value){for(var useValue=arguments.length>2,i=0;i<initializers.length;i++)value=useValue?initializers[i].call(thisArg,value):initializers[i].call(thisArg);return useValue?value:void 0},__esDecorate=this&&this.__esDecorate||function(ctor,descriptorIn,decorators,contextIn,initializers,extraInitializers){function accept(f){if(void 0!==f&&"function"!=typeof f)throw new TypeError("Function expected");return f}for(var _,kind=contextIn.kind,key="getter"===kind?"get":"setter"===kind?"set":"value",target=!descriptorIn&&ctor?contextIn.static?ctor:ctor.prototype:null,descriptor=descriptorIn||(target?Object.getOwnPropertyDescriptor(target,contextIn.name):{}),done=!1,i=decorators.length-1;i>=0;i--){var context={};for(var p in contextIn)context[p]="access"===p?{}:contextIn[p];for(var p in contextIn.access)context.access[p]=contextIn.access[p];context.addInitializer=function(f){if(done)throw new TypeError("Cannot add initializers after decoration has completed");extraInitializers.push(accept(f||null))};var result=(0,decorators[i])("accessor"===kind?{get:descriptor.get,set:descriptor.set}:descriptor[key],context);if("accessor"===kind){if(void 0===result)continue;if(null===result||"object"!=typeof result)throw new TypeError("Object expected");(_=accept(result.get))&&(descriptor.get=_),(_=accept(result.set))&&(descriptor.set=_),(_=accept(result.init))&&initializers.unshift(_)}else(_=accept(result))&&("field"===kind?initializers.unshift(_):descriptor[key]=_)}target&&Object.defineProperty(target,contextIn.name,descriptor),done=!0};!function(TcHmi){!function(Controls){!function(Helpers){let DragAndDropDisplay=(()=>{let ___onDragStart_decorators,___onDragOver_decorators,___onDrop_decorators,___onDragEnd_decorators,_classSuper=Helpers.Display,_instanceExtraInitializers=[];return class extends _classSuper{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(_classSuper[Symbol.metadata]??null):void 0;___onDragStart_decorators=[TcHmi.CallbackMethod],___onDragOver_decorators=[TcHmi.CallbackMethod],___onDrop_decorators=[TcHmi.CallbackMethod],___onDragEnd_decorators=[TcHmi.CallbackMethod],__esDecorate(this,null,___onDragStart_decorators,{kind:"method",name:"__onDragStart",static:!1,private:!1,access:{has:obj=>"__onDragStart"in obj,get:obj=>obj.__onDragStart},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onDragOver_decorators,{kind:"method",name:"__onDragOver",static:!1,private:!1,access:{has:obj=>"__onDragOver"in obj,get:obj=>obj.__onDragOver},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onDrop_decorators,{kind:"method",name:"__onDrop",static:!1,private:!1,access:{has:obj=>"__onDrop"in obj,get:obj=>obj.__onDrop},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onDragEnd_decorators,{kind:"method",name:"__onDragEnd",static:!1,private:!1,access:{has:obj=>"__onDragEnd"in obj,get:obj=>obj.__onDragEnd},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}__dragAndDropAllowed=(__runInitializers(this,_instanceExtraInitializers),!1);__draggedElement=null;__dropElement=null;__eventDestroyers=[];__onDragAndDropManager=new TcHmi.Controls.Helpers.CallbackManager;onDragAndDrop=this.__onDragAndDropManager.getManipulators();constructor(element,parentControl){super(element,parentControl)}__onDragStart(event){event.target instanceof HTMLElement&&event.target.dataset.name&&event.dataTransfer&&this.__parentControl.getIsEnabled()&&TcHmi.Access.checkAccess(this.__parentControl,"operate")&&(event.dataTransfer.setData("text/plain",event.target.dataset.name),this.__draggedElement=event.target,this.__draggedElement.classList.add("dragging"))}__onDragOver(event){this.__draggedElement&&event.target instanceof HTMLElement&&event.dataTransfer&&this.__parentControl.getIsEnabled()&&TcHmi.Access.checkAccess(this.__parentControl,"operate")&&(event.target!==this.__draggedElement&&event.target.classList.contains("folder")?(event.dataTransfer.dropEffect="move",event.preventDefault(),this.__dropElement&&this.__dropElement.classList.remove("drop-zone"),this.__dropElement=event.target,this.__dropElement.classList.add("drop-zone")):this.__dropElement&&(this.__dropElement.classList.remove("drop-zone"),this.__dropElement=null))}__onDrop(event){if(!this.__draggedElement)return;if(!(event.target instanceof HTMLElement))return;if(!event.dataTransfer)return;if(!this.__parentControl.getIsEnabled()||!TcHmi.Access.checkAccess(this.__parentControl,"operate"))return;const name=event.dataTransfer.getData("text/plain");if(!name||!this.__element.querySelector(`[data-name="${name}"]`))return;const dropName=event.target.dataset.name;dropName&&(this.__onDragAndDropManager.trigger([name],{name:dropName,isParent:"true"===event.target.dataset.isParent}),this.__draggedElement.classList.remove("dragging"),this.__draggedElement=null,this.__dropElement?.classList.remove("drop-zone"),this.__dropElement=null,event.preventDefault())}__onDragEnd(_event){this.__draggedElement&&(this.__draggedElement.classList.remove("dragging"),this.__draggedElement=null),this.__dropElement&&(this.__dropElement.classList.remove("drop-zone"),this.__dropElement=null)}suspend(clear=!1){super.suspend(clear),this.__dragAndDropAllowed&&this.__removeDragAndDropHandlers()}resume(){this.__dragAndDropAllowed&&this.__addDragAndDropHandlers()}setDragAndDropAllowed(valueNew){this.__dragAndDropAllowed!==valueNew&&(this.__dragAndDropAllowed=valueNew,this.__processDragAndDropAllowed())}getDragAndDropAllowed(){return this.__dragAndDropAllowed}__processDragAndDropAllowed(){this.__dragAndDropAllowed?this.__addDragAndDropHandlers():this.__removeDragAndDropHandlers()}__addDragAndDropHandlers(){this.__eventDestroyers.push(TcHmi.EventProvider.registerDomEvent(this.__element,"dragstart",this.__onDragStart),TcHmi.EventProvider.registerDomEvent(this.__element,"dragover",this.__onDragOver,{passive:!1}),TcHmi.EventProvider.registerDomEvent(this.__element,"drop",this.__onDrop,{passive:!1}),TcHmi.EventProvider.registerDomEvent(this.__element,"dragend",this.__onDragEnd))}__removeDragAndDropHandlers(){for(const destroyer of this.__eventDestroyers)destroyer();this.__eventDestroyers=[]}}})();Helpers.DragAndDropDisplay=DragAndDropDisplay}(Controls.Helpers||(Controls.Helpers={}))}(TcHmi.Controls||(TcHmi.Controls={}))}(TcHmi||(TcHmi={})),function(TcHmi){!function(Controls){!function(Helpers){let PathDisplay=(()=>{let ___onClick_decorators,___onMouseDown_decorators,___onMouseUp_decorators,___onMouseMove_decorators,_classSuper=Helpers.Display,_instanceExtraInitializers=[];return class extends _classSuper{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(_classSuper[Symbol.metadata]??null):void 0;___onClick_decorators=[TcHmi.CallbackMethod],___onMouseDown_decorators=[TcHmi.CallbackMethod],___onMouseUp_decorators=[TcHmi.CallbackMethod],___onMouseMove_decorators=[TcHmi.CallbackMethod],__esDecorate(this,null,___onClick_decorators,{kind:"method",name:"__onClick",static:!1,private:!1,access:{has:obj=>"__onClick"in obj,get:obj=>obj.__onClick},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onMouseDown_decorators,{kind:"method",name:"__onMouseDown",static:!1,private:!1,access:{has:obj=>"__onMouseDown"in obj,get:obj=>obj.__onMouseDown},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onMouseUp_decorators,{kind:"method",name:"__onMouseUp",static:!1,private:!1,access:{has:obj=>"__onMouseUp"in obj,get:obj=>obj.__onMouseUp},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onMouseMove_decorators,{kind:"method",name:"__onMouseMove",static:!1,private:!1,access:{has:obj=>"__onMouseMove"in obj,get:obj=>obj.__onMouseMove},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}__scrollContainer=__runInitializers(this,_instanceExtraInitializers);__itemListElement;__mouseDragScrolling=!1;__eventDestroyers=[];constructor(element,parentControl){super(element,parentControl),this.__element.classList.add("TcHmi_Controls_Helpers_DirectoryBrowser-path-display"),this.__scrollContainer=document.createElement("div"),this.__scrollContainer.classList.add("TcHmi_Controls_Helpers_DirectoryBrowser-path-display-scroll-container"),this.__itemListElement=document.createElement("ul"),this.__itemListElement.classList.add("TcHmi_Controls_Helpers_DirectoryBrowser-path-display-item-list"),this.__scrollContainer.appendChild(this.__itemListElement),this.__element.appendChild(this.__scrollContainer)}__onClick(event){if(!this.__directory)return;if(!(event.target instanceof Element))return;if(!this.__parentControl.getIsEnabled()||!TcHmi.Access.checkAccess(this.__parentControl,"operate"))return;const target=event.target.closest("li");if(!target||!this.__itemListElement.contains(target))return;const path=target.dataset.path;this.__directory.setPathAndValidate(path?path.split("::"):[])}__onMouseDown(event){this.__directory&&event.target instanceof Element&&this.__parentControl.getIsEnabled()&&TcHmi.Access.checkAccess(this.__parentControl,"observe")&&(this.__mouseDragScrolling=!0)}__onMouseUp(event){this.__mouseDragScrolling=!1}__onMouseMove(event){this.__mouseDragScrolling&&(this.__scrollContainer.scrollLeft-=event.movementX)}suspend(clear=!1){if(!this.__suspended){super.suspend(clear);for(const destroyer of this.__eventDestroyers)destroyer();this.__eventDestroyers=[],clear&&this.__updatePath(null)}}resume(){this.__suspended&&(super.resume(),this.__eventDestroyers.push(TcHmi.EventProvider.registerDomEvent(this.__itemListElement,"click",this.__onClick),TcHmi.EventProvider.registerDomEvent(this.__element,"mousedown",this.__onMouseDown),TcHmi.EventProvider.registerDomEvent(document,"mouseup",this.__onMouseUp),TcHmi.EventProvider.registerDomEvent(document,"mousemove",this.__onMouseMove)),this.__processDirectory())}__processDirectory(){this.__directory&&this.__directory.onPathChange.add(()=>this.__updatePath(this.__directory?.decoratedPath)),this.__updatePath(this.__directory?.decoratedPath)}__updatePath(path){if(!path){for(;this.__itemListElement.firstChild;)this.__itemListElement.firstChild.remove();return}const fragment=document.createDocumentFragment();let currentElement=this.__itemListElement.firstElementChild;for(const item of path)currentElement instanceof HTMLLIElement?this.__createOrUpdateListElement(item,currentElement):(currentElement=this.__createOrUpdateListElement(item),fragment.appendChild(currentElement)),currentElement=currentElement.nextElementSibling;for(;currentElement;){const toRemove=currentElement;currentElement=currentElement.nextElementSibling,toRemove.remove()}fragment.childElementCount>0&&this.__itemListElement.appendChild(fragment)}__createOrUpdateListElement(item,element){let li,a;li=element instanceof HTMLElement?element:document.createElement("li"),li.firstElementChild?a=li.firstElementChild:(a=document.createElement("a"),li.appendChild(a));const displayName=item.type!==Helpers.DirectoryBrowser.ItemType.Root?item.name:"/";a.textContent!==displayName&&(a.textContent=displayName);const className=item.type===Helpers.DirectoryBrowser.ItemType.File?"file":"folder";li.className!==className&&(li.className=className);for(const key in li.dataset)delete li.dataset[key];if(item.metadata)for(const key in item.metadata){const type=typeof item.metadata[key];if("string"===type||"number"===type||"boolean"===type)try{li.dataset["metadata"+key.slice(0,1).toUpperCase()+key.slice(1)]=item.metadata[key]}catch(e){TcHmi.Log.errorEx(`[Source=Control, Module=TcHmi.Controls.Helpers.DirectoryBrowser, ControlId=${this.__parentControl.getId()}] The metadata property "${key}" contains characters that cannot be used in a data-attribute. Please use only letters, numbers, periods, colons and underscores in metadata property names.`)}}return li.dataset.path=Helpers.DirectoryBrowser.getPath(item).join("::"),li}}})();Helpers.PathDisplay=PathDisplay}(Controls.Helpers||(Controls.Helpers={}))}(TcHmi.Controls||(TcHmi.Controls={}))}(TcHmi||(TcHmi={})),function(TcHmi){!function(Controls){!function(Helpers){let ListBrowsingDisplay=(()=>{let ___onPointerDown_decorators,___onPointerUp_decorators,___onPointerMove_decorators,___onScroll_decorators,___onContextMenu_decorators,_classSuper=Helpers.Display,_instanceExtraInitializers=[];return class ListBrowsingDisplay extends _classSuper{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(_classSuper[Symbol.metadata]??null):void 0;___onPointerDown_decorators=[TcHmi.CallbackMethod],___onPointerUp_decorators=[TcHmi.CallbackMethod],___onPointerMove_decorators=[TcHmi.CallbackMethod],___onScroll_decorators=[TcHmi.CallbackMethod],___onContextMenu_decorators=[TcHmi.CallbackMethod],__esDecorate(this,null,___onPointerDown_decorators,{kind:"method",name:"__onPointerDown",static:!1,private:!1,access:{has:obj=>"__onPointerDown"in obj,get:obj=>obj.__onPointerDown},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onPointerUp_decorators,{kind:"method",name:"__onPointerUp",static:!1,private:!1,access:{has:obj=>"__onPointerUp"in obj,get:obj=>obj.__onPointerUp},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onPointerMove_decorators,{kind:"method",name:"__onPointerMove",static:!1,private:!1,access:{has:obj=>"__onPointerMove"in obj,get:obj=>obj.__onPointerMove},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onScroll_decorators,{kind:"method",name:"__onScroll",static:!1,private:!1,access:{has:obj=>"__onScroll"in obj,get:obj=>obj.__onScroll},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onContextMenu_decorators,{kind:"method",name:"__onContextMenu",static:!1,private:!1,access:{has:obj=>"__onContextMenu"in obj,get:obj=>obj.__onContextMenu},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}__showingParent=(__runInitializers(this,_instanceExtraInitializers),!1);__lastPointerDown={type:"",timestamp:0,doubleClickOnNextUp:!1,ignoreNextUp:!1,target:null,timeoutID:0,coords:{x:0,y:0}};__pointerMultiselect=!1;__formatMetadata=null;__search=null;__sort=null;__defaultSort={sorting:[{name:"type",order:"Descending"},{name:"name",order:"Ascending"}],caseSensitive:!1};__eventDestroyers=[];constructor(element,parentControl){super(element,parentControl),this.__element.classList.add("TcHmi_Controls_Helpers_DirectoryBrowser-browsing-display")}__onPointerDown(event){clearTimeout(this.__lastPointerDown.timeoutID),this.__lastPointerDown.timeoutID=0,this.__lastPointerDown.ignoreNextUp=!1,this.__lastPointerDown.coords.x=event.clientX,this.__lastPointerDown.coords.y=event.clientY;const eventInfo=this.__preprocessPointerEvent(event);if(!eventInfo)return this.__lastPointerDown.target=event.target,void(this.__lastPointerDown.doubleClickOnNextUp=!1);const now=Date.now();this.__lastPointerDown.type===event.pointerType&&this.__lastPointerDown.target===eventInfo.target&&now-this.__lastPointerDown.timestamp<=500&&(this.__lastPointerDown.doubleClickOnNextUp=!0),this.__lastPointerDown.type=event.pointerType,this.__lastPointerDown.timestamp=now,this.__lastPointerDown.target=eventInfo.target,this.__lastPointerDown.timeoutID=setTimeout(()=>{this.__lastPointerDown.timeoutID=0,this.__lastPointerDown.doubleClickOnNextUp=!1,this.__lastPointerDown.ignoreNextUp=!0,this.__pointerMultiselect=!0,this.__select(eventInfo)},500)}__onPointerUp(event){if(clearTimeout(this.__lastPointerDown.timeoutID),this.__lastPointerDown.timeoutID=0,this.__lastPointerDown.ignoreNextUp)return void(this.__lastPointerDown.ignoreNextUp=!1);if(this.__lastPointerDown.type!==event.pointerType)return;const eventInfo=this.__preprocessPointerEvent(event);if(!eventInfo)return this.__lastPointerDown.target===event.target&&(this.__select(null),this.__pointerMultiselect=!1),this.__lastPointerDown.target=null,void(this.__lastPointerDown.doubleClickOnNextUp=!1);this.__lastPointerDown.target===eventInfo.target&&(this.__lastPointerDown.doubleClickOnNextUp?(this.__navigate(eventInfo),this.__lastPointerDown.doubleClickOnNextUp=!1,this.__lastPointerDown.timestamp=0):this.__select(eventInfo))}__onPointerMove(event){if(0===this.__lastPointerDown.timeoutID)return;const deltaX=this.__lastPointerDown.coords.x-event.clientX,deltaY=this.__lastPointerDown.coords.y-event.clientY;deltaX*deltaX+deltaY*deltaY>225&&(clearTimeout(this.__lastPointerDown.timeoutID),this.__lastPointerDown.timeoutID=0)}__onScroll(){clearTimeout(this.__lastPointerDown.timeoutID),this.__lastPointerDown.timeoutID=0}__onContextMenu(event){this.__pointerMultiselect&&event.preventDefault()}__preprocessPointerEvent(event){if(!this.__directory)return!1;if(!(event.target instanceof Element))return!1;if("mouse"===event.pointerType&&0!==event.button)return!1;if(!this.__parentControl.getIsEnabled()||!TcHmi.Access.checkAccess(this.__parentControl,"operate"))return!1;const target=event.target.closest("li");if(!target||!this.__element.contains(target))return!1;const name=target.dataset.name,isParent="true"===target.dataset.isParent;return!(!isParent&&!name)&&{target,item:isParent?{isParent:!0}:{isParent:!1,name},multiselect:event.ctrlKey||this.__pointerMultiselect}}async __select(event){this.__directory&&(event?event.item.isParent||(event.multiselect&&this.__directory.selectedItemNames.has(event.item.name)?(await this.__directory.deselectItem(event.item.name),0===this.__directory.selectedItemNames.size&&(this.__pointerMultiselect=!1)):this.__directory.selectItem(event.item.name,event.multiselect)):this.__directory.clearSelection())}__navigate(event){if(this.__directory)if(this.__showingParent){const path=tchmi_clone_object(this.__directory.path);path.pop(),event.item.isParent?path.pop():path.push(event.item.name),this.__directory.setPathAndValidate(path)}else event.item.isParent?this.__directory.popPath():this.__directory.pushPath(event.item.name)}suspend(clear=!1){if(!this.__suspended){super.suspend(clear);for(const destroyer of this.__eventDestroyers)destroyer();this.__eventDestroyers=[],clear&&this.__updateCurrentItem(null)}}resume(){this.__suspended&&(super.resume(),this.__eventDestroyers.push(TcHmi.EventProvider.registerDomEvent(document,"pointerdown",this.__onPointerDown),TcHmi.EventProvider.registerDomEvent(document,"pointermove",this.__onPointerMove),TcHmi.EventProvider.registerDomEvent(document,"scroll",this.__onScroll),TcHmi.EventProvider.registerDomEvent(this.__element,"pointerup",this.__onPointerUp),TcHmi.EventProvider.registerDomEvent(this.__element,"contextmenu",this.__onContextMenu,{passive:!1})),this.__processDirectory())}showMetadata(metadataFormatter){this.__formatMetadata=metadataFormatter,this.__updateCurrentItem(this.__directory?.currentItem)}hideMetadata(){this.__formatMetadata=null,this.__updateCurrentItem(this.__directory?.currentItem)}search(term,caseSensitive=!1){this.__search=term?{term:caseSensitive?term:term.toLowerCase(),caseSensitive}:null,this.__updateCurrentItem(this.__directory?.currentItem)}sort(sorting,caseSensitive=!1){this.__sort=sorting?{sorting,caseSensitive}:null,this.__updateCurrentItem(this.__directory?.currentItem)}__processDirectory(){this.__directory&&(this.__directory.onPathChange.add(currentItem=>this.__updateCurrentItem(currentItem)),this.__directory.onCurrentItemUpdate.add(currentItem=>this.__updateCurrentItem(currentItem)),this.__directory.onSelectionChange.add(()=>this.__updateSelection())),this.__updateCurrentItem(this.__directory?.currentItem)}__updateCurrentItem(currentItem){if(!currentItem||!this.__directory){for(;this.__element.firstChild;)this.__element.firstChild.remove();return}let currentFolder=currentItem;currentFolder.type===Helpers.DirectoryBrowser.ItemType.File?(currentFolder=currentFolder.parent,this.__showingParent=!0):this.__showingParent=!1;let directoryItems=Array.from(currentFolder.children.values());this.__search&&(directoryItems=directoryItems.filter(item=>{if(!this.__search)return!0;return(this.__search.caseSensitive?item.name:item.name.toLowerCase()).includes(this.__search.term)})),directoryItems.sort(Helpers.DirectoryBrowser.compare.bind(this,this.__sort??this.__defaultSort));const fragment=document.createDocumentFragment();let currentElement=this.__element.firstElementChild;currentFolder.type===Helpers.DirectoryBrowser.ItemType.Folder&&(currentElement instanceof HTMLLIElement?this.__createOrUpdateListElement(currentFolder.parent,ListBrowsingDisplay.ListItemStatus.Parent,currentElement):(currentElement=this.__createOrUpdateListElement(currentFolder.parent,ListBrowsingDisplay.ListItemStatus.Parent),fragment.appendChild(currentElement)),currentElement=currentElement.nextElementSibling);for(const item of directoryItems){let status=ListBrowsingDisplay.ListItemStatus.Default;this.__directory.selectedItemNames.has(item.name)?status=ListBrowsingDisplay.ListItemStatus.Selected:item===currentItem&&(status=ListBrowsingDisplay.ListItemStatus.Current),currentElement instanceof HTMLLIElement?this.__createOrUpdateListElement(item,status,currentElement):(currentElement=this.__createOrUpdateListElement(item,status),fragment.appendChild(currentElement)),currentElement=currentElement.nextElementSibling}for(;currentElement;){const toRemove=currentElement;currentElement=currentElement.nextElementSibling,toRemove.remove()}fragment.childElementCount>0&&this.__element.appendChild(fragment)}__createOrUpdateListElement(item,status=ListBrowsingDisplay.ListItemStatus.Default,element){let li;li=element||document.createElement("li");const displayName=status!==ListBrowsingDisplay.ListItemStatus.Parent&&item.type!==Helpers.DirectoryBrowser.ItemType.Root?item.name:"..";li.textContent!==displayName&&(li.textContent=displayName);const className=item.type===Helpers.DirectoryBrowser.ItemType.File?"file":"folder";li.className!==className&&(li.className=className);for(const key in li.dataset)delete li.dataset[key];switch(status){case ListBrowsingDisplay.ListItemStatus.Selected:li.classList.add("selected");break;case ListBrowsingDisplay.ListItemStatus.Current:li.classList.add("current");break;case ListBrowsingDisplay.ListItemStatus.Parent:li.dataset.isParent="true"}if(status!==ListBrowsingDisplay.ListItemStatus.Parent&&item.type!==Helpers.DirectoryBrowser.ItemType.Root&&(li.dataset.name=item.name),item.metadata)for(const key in item.metadata){const type=typeof item.metadata[key];if("string"===type||"number"===type||"boolean"===type)try{li.dataset["metadata"+key.slice(0,1).toUpperCase()+key.slice(1)]=item.metadata[key]}catch(e){TcHmi.Log.errorEx(`[Source=Control, Module=TcHmi.Controls.Helpers.DirectoryBrowser, ControlId=${this.__parentControl.getId()}] The metadata property "${key}" contains characters that cannot be used in a data-attribute. Please use only letters, numbers, periods, colons and underscores in metadata property names.`)}}let metadataDisplay=li.querySelector("span");return status!==ListBrowsingDisplay.ListItemStatus.Parent&&this.__formatMetadata?(metadataDisplay||(metadataDisplay=li.appendChild(document.createElement("span"))),metadataDisplay.textContent=this.__formatMetadata(item)):metadataDisplay&&metadataDisplay.remove(),li}__updateSelection(){if(this.__directory)for(const child of this.__element.children){if(!(child instanceof HTMLLIElement))continue;const name=child.dataset.name;name&&child.classList.toggle("selected",this.__directory.selectedItemNames.has(name))}}}})();Helpers.ListBrowsingDisplay=ListBrowsingDisplay,function(ListBrowsingDisplay){let ListItemStatus;!function(ListItemStatus){ListItemStatus[ListItemStatus.Default=0]="Default",ListItemStatus[ListItemStatus.Selected=1]="Selected",ListItemStatus[ListItemStatus.Current=2]="Current",ListItemStatus[ListItemStatus.Parent=3]="Parent"}(ListItemStatus=ListBrowsingDisplay.ListItemStatus||(ListBrowsingDisplay.ListItemStatus={}))}(ListBrowsingDisplay=Helpers.ListBrowsingDisplay||(Helpers.ListBrowsingDisplay={}))}(Controls.Helpers||(Controls.Helpers={}))}(TcHmi.Controls||(TcHmi.Controls={}))}(TcHmi||(TcHmi={})),function(TcHmi){!function(Controls){!function(Helpers){let TreeBrowsingDisplay=(()=>{let ___onPointerDown_decorators,___onPointerUp_decorators,___onClick_decorators,___onPointerMove_decorators,___onScroll_decorators,___onContextMenu_decorators,___onToggle_decorators,_classSuper=Helpers.Display,_instanceExtraInitializers=[];return class extends _classSuper{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(_classSuper[Symbol.metadata]??null):void 0;___onPointerDown_decorators=[TcHmi.CallbackMethod],___onPointerUp_decorators=[TcHmi.CallbackMethod],___onClick_decorators=[TcHmi.CallbackMethod],___onPointerMove_decorators=[TcHmi.CallbackMethod],___onScroll_decorators=[TcHmi.CallbackMethod],___onContextMenu_decorators=[TcHmi.CallbackMethod],___onToggle_decorators=[TcHmi.CallbackMethod],__esDecorate(this,null,___onPointerDown_decorators,{kind:"method",name:"__onPointerDown",static:!1,private:!1,access:{has:obj=>"__onPointerDown"in obj,get:obj=>obj.__onPointerDown},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onPointerUp_decorators,{kind:"method",name:"__onPointerUp",static:!1,private:!1,access:{has:obj=>"__onPointerUp"in obj,get:obj=>obj.__onPointerUp},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onClick_decorators,{kind:"method",name:"__onClick",static:!1,private:!1,access:{has:obj=>"__onClick"in obj,get:obj=>obj.__onClick},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onPointerMove_decorators,{kind:"method",name:"__onPointerMove",static:!1,private:!1,access:{has:obj=>"__onPointerMove"in obj,get:obj=>obj.__onPointerMove},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onScroll_decorators,{kind:"method",name:"__onScroll",static:!1,private:!1,access:{has:obj=>"__onScroll"in obj,get:obj=>obj.__onScroll},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onContextMenu_decorators,{kind:"method",name:"__onContextMenu",static:!1,private:!1,access:{has:obj=>"__onContextMenu"in obj,get:obj=>obj.__onContextMenu},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onToggle_decorators,{kind:"method",name:"__onToggle",static:!1,private:!1,access:{has:obj=>"__onToggle"in obj,get:obj=>obj.__onToggle},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}__treeItems=(__runInitializers(this,_instanceExtraInitializers),new Map);__expandedItems=new Set;__lastPointerDown={type:"",timestamp:0,doubleClickOnNextUp:!1,ignoreNextUp:!1,target:null,timeoutID:0,coords:{x:0,y:0}};__pointerMultiselect=!1;__search=null;__sort=null;__defaultSort={sorting:[{name:"type",order:"Descending"},{name:"name",order:"Ascending"}],caseSensitive:!1};__eventDestroyers=[];constructor(element,parentControl){super(element,parentControl),element.classList.add("TcHmi_Controls_Helpers_DirectoryBrowser-tree-browsing-display")}__onPointerDown(event){clearTimeout(this.__lastPointerDown.timeoutID),this.__lastPointerDown.timeoutID=0,this.__lastPointerDown.ignoreNextUp=!1,this.__lastPointerDown.coords.x=event.clientX,this.__lastPointerDown.coords.y=event.clientY;const eventInfo=this.__preprocessPointerEvent(event);if("Row"!==eventInfo.type)return this.__lastPointerDown.target=event.target,void(this.__lastPointerDown.doubleClickOnNextUp=!1);const now=Date.now();this.__lastPointerDown.type===event.pointerType&&this.__lastPointerDown.target===eventInfo.row&&now-this.__lastPointerDown.timestamp<=500&&(this.__lastPointerDown.doubleClickOnNextUp=!0),this.__lastPointerDown.type=event.pointerType,this.__lastPointerDown.timestamp=now,this.__lastPointerDown.target=eventInfo.row,this.__lastPointerDown.timeoutID=setTimeout(()=>{this.__lastPointerDown.timeoutID=0,this.__lastPointerDown.doubleClickOnNextUp=!1,this.__lastPointerDown.ignoreNextUp=!0,this.__pointerMultiselect=!0,this.__select(eventInfo)},500)}__onPointerUp(event){if(clearTimeout(this.__lastPointerDown.timeoutID),this.__lastPointerDown.timeoutID=0,this.__lastPointerDown.ignoreNextUp)return void(this.__lastPointerDown.ignoreNextUp=!1);if(this.__lastPointerDown.type!==event.pointerType)return;const eventInfo=this.__preprocessPointerEvent(event);switch(eventInfo.type){case"Clear":this.__lastPointerDown.target===event.target&&(this.__select(null),this.__pointerMultiselect=!1);case"Ignore":return this.__lastPointerDown.target=null,void(this.__lastPointerDown.doubleClickOnNextUp=!1)}this.__lastPointerDown.target===eventInfo.row&&(this.__lastPointerDown.doubleClickOnNextUp?(this.__navigate(eventInfo),this.__lastPointerDown.doubleClickOnNextUp=!1,this.__lastPointerDown.timestamp=0):this.__select(eventInfo))}__onClick(event){event.target instanceof HTMLElement&&event.target.classList.contains("group-lines")&&event.preventDefault()}__onPointerMove(event){if(0===this.__lastPointerDown.timeoutID)return;const deltaX=this.__lastPointerDown.coords.x-event.clientX,deltaY=this.__lastPointerDown.coords.y-event.clientY;deltaX*deltaX+deltaY*deltaY>225&&(clearTimeout(this.__lastPointerDown.timeoutID),this.__lastPointerDown.timeoutID=0)}__onScroll(){clearTimeout(this.__lastPointerDown.timeoutID),this.__lastPointerDown.timeoutID=0}__onContextMenu(event){this.__pointerMultiselect&&event.preventDefault()}__onToggle(event){if(!(event.target instanceof HTMLDetailsElement))return;const summary=event.target.querySelector("summary");if(!summary)return;const item=this.__treeItems.get(summary);item?.type===Helpers.DirectoryBrowser.ItemType.Folder&&(event.target.open?this.__expandedItems.add(Helpers.DirectoryBrowser.getPath(item).join("::")):this.__expandedItems.delete(Helpers.DirectoryBrowser.getPath(item).join("::")))}__preprocessPointerEvent(event){if(!this.__directory)return{type:"Ignore"};if(!(event.target instanceof HTMLElement))return{type:"Ignore"};if("mouse"===event.pointerType&&0!==event.button)return{type:"Ignore"};if(!this.__parentControl.getIsEnabled()||!TcHmi.Access.checkAccess(this.__parentControl,"operate"))return{type:"Ignore"};if("SUMMARY"===event.target.tagName.toUpperCase()||event.target.classList.contains("expander"))return{type:"Ignore"};const row=event.target.closest("summary, div");if(!row)return{type:"Clear"};const item=this.__treeItems.get(row);return item?{type:"Row",row,item,multiselect:event.ctrlKey||this.__pointerMultiselect}:{type:"Clear"}}async __select(event){this.__directory&&(event?event.multiselect&&this.__directory.selectedItems.includes(event.item)?(await this.__directory.deselectItem(event.item),0===this.__directory.selectedItemNames.size&&(this.__pointerMultiselect=!1)):this.__directory.selectItem(event.item,event.multiselect):this.__directory.clearSelection())}__navigate(event){this.__directory&&this.__directory.setPathAndValidate(Helpers.DirectoryBrowser.getPath(event.item))}suspend(clear=!1){if(!this.__suspended){super.suspend(clear);for(const destroyer of this.__eventDestroyers)destroyer();this.__eventDestroyers=[],clear&&(this.__element.innerHTML="",this.__treeItems.clear(),this.__expandedItems.clear())}}resume(){this.__suspended&&(super.resume(),this.__eventDestroyers.push(TcHmi.EventProvider.registerDomEvent(document,"pointerdown",this.__onPointerDown),TcHmi.EventProvider.registerDomEvent(document,"pointermove",this.__onPointerMove),TcHmi.EventProvider.registerDomEvent(document,"scroll",this.__onScroll),TcHmi.EventProvider.registerDomEvent(this.__element,"pointerup",this.__onPointerUp),TcHmi.EventProvider.registerDomEvent(this.__element,"click",this.__onClick,{passive:!1}),TcHmi.EventProvider.registerDomEvent(this.__element,"contextmenu",this.__onContextMenu,{passive:!1}),TcHmi.EventProvider.registerDomEvent(this.__element,"toggle",this.__onToggle,{capture:!0})),this.__processDirectory())}search(term,caseSensitive=!1){this.__search=term?{term:caseSensitive?term:term.toLowerCase(),caseSensitive}:null,this.__performSearch()}__performSearch(){if(this.__search){for(const[element,item]of this.__treeItems)element.classList.toggle("match",this.__search.caseSensitive?item.name.includes(this.__search.term):item.name.toLowerCase().includes(this.__search.term));this.__element.classList.add("filter")}else{this.__element.classList.remove("filter");for(const element of this.__element.querySelectorAll(".match"))element.classList.remove("match")}}sort(sorting,caseSensitive=!1){this.__sort=sorting?{sorting,caseSensitive}:null,this.__render()}__processDirectory(){this.__render(),this.__directory&&this.__directoryEventDestroyers.push(this.__directory.onDirectoryUpdate.add(()=>this.__render()),this.__directory.onSelectionChange.add(selectedItems=>{for(const[element,item]of this.__treeItems)element.classList.toggle("selected",selectedItems.includes(item))}),this.__directory.onPathChange.add(currentItem=>{for(const[element,item]of this.__treeItems)element.classList.toggle("current",item===currentItem)}))}__render(){this.__element.innerHTML="",this.__treeItems.clear(),this.__directory&&this.__element.appendChild(this.__buildTree(this.__directory.root)),this.__performSearch()}__buildTree(directory,path=[]){const fragment=document.createDocumentFragment(),directoryItems=Array.from(directory.children.values()).sort(Helpers.DirectoryBrowser.compare.bind(this,this.__sort??this.__defaultSort));for(const item of directoryItems){let row;if(item.type===Helpers.DirectoryBrowser.ItemType.Folder){const details=fragment.appendChild(document.createElement("details"));row=details.appendChild(document.createElement("summary")),0!==item.children.size&&details.appendChild(this.__buildTree(item,[...path,item.name])),this.__expandedItems.has(Helpers.DirectoryBrowser.getPath(item).join("::"))&&(details.open=!0)}else row=fragment.appendChild(document.createElement("div"));const groupLines=row.appendChild(document.createElement("span"));groupLines.className="group-lines";for(const _ of path)groupLines.appendChild(document.createElement("span"));row.appendChild(document.createElement("span")).className="expander";row.appendChild(document.createElement("label")).textContent=item.name,item===this.__directory?.currentItem&&row.classList.add("current"),this.__directory?.selectedItems.includes(item)&&row.classList.add("selected"),this.__treeItems.set(row,item)}return fragment}}})();Helpers.TreeBrowsingDisplay=TreeBrowsingDisplay}(Controls.Helpers||(Controls.Helpers={}))}(TcHmi.Controls||(TcHmi.Controls={}))}(TcHmi||(TcHmi={})),function(TcHmi){!function(Controls){!function(Helpers){let DirectoryBrowser=(()=>{let ___onBeforePathChange_decorators,___onBeforeSelectionChange_decorators,___onSelectionChange_decorators,___onSelectedItemUpdate_decorators,___onPathChange_decorators,___onCurrentItemChange_decorators,_instanceExtraInitializers=[];return class DirectoryBrowser{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;___onBeforePathChange_decorators=[TcHmi.CallbackMethod],___onBeforeSelectionChange_decorators=[TcHmi.CallbackMethod],___onSelectionChange_decorators=[TcHmi.CallbackMethod],___onSelectedItemUpdate_decorators=[TcHmi.CallbackMethod],___onPathChange_decorators=[TcHmi.CallbackMethod],___onCurrentItemChange_decorators=[TcHmi.CallbackMethod],__esDecorate(this,null,___onBeforePathChange_decorators,{kind:"method",name:"__onBeforePathChange",static:!1,private:!1,access:{has:obj=>"__onBeforePathChange"in obj,get:obj=>obj.__onBeforePathChange},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onBeforeSelectionChange_decorators,{kind:"method",name:"__onBeforeSelectionChange",static:!1,private:!1,access:{has:obj=>"__onBeforeSelectionChange"in obj,get:obj=>obj.__onBeforeSelectionChange},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onSelectionChange_decorators,{kind:"method",name:"__onSelectionChange",static:!1,private:!1,access:{has:obj=>"__onSelectionChange"in obj,get:obj=>obj.__onSelectionChange},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onSelectedItemUpdate_decorators,{kind:"method",name:"__onSelectedItemUpdate",static:!1,private:!1,access:{has:obj=>"__onSelectedItemUpdate"in obj,get:obj=>obj.__onSelectedItemUpdate},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onPathChange_decorators,{kind:"method",name:"__onPathChange",static:!1,private:!1,access:{has:obj=>"__onPathChange"in obj,get:obj=>obj.__onPathChange},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onCurrentItemChange_decorators,{kind:"method",name:"__onCurrentItemChange",static:!1,private:!1,access:{has:obj=>"__onCurrentItemChange"in obj,get:obj=>obj.__onCurrentItemChange},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}__displays=__runInitializers(this,_instanceExtraInitializers);__directory=null;__suspended=!0;__autoSuspended=!1;__directoryUpdatesSuspension={suspended:!1,cachedUpdate:void 0};__fakeFile=null;__pathToSet=null;__itemsToSelect=[];__navigationToFilesAllowedCache=!0;__multiSelectAllowedCache=!1;__onBeforePathChangeManager=new Helpers.AsyncCallbackManager;onBeforePathChange=this.__onBeforePathChangeManager.getManipulators();__onBeforeSelectionChangeManager=new Helpers.AsyncCallbackManager;onBeforeSelectionChange=this.__onBeforeSelectionChangeManager.getManipulators();__onSelectionChangeManager=new Helpers.CallbackManager;onSelectionChange=this.__onSelectionChangeManager.getManipulators();__onSelectedItemUpdateManager=new Helpers.CallbackManager;onSelectedItemUpdate=this.__onSelectedItemUpdateManager.getManipulators();__onPathChangeManager=new Helpers.CallbackManager;onPathChange=this.__onPathChangeManager.getManipulators();__onCurrentItemUpdateManager=new Helpers.CallbackManager;onCurrentItemUpdate=this.__onCurrentItemUpdateManager.getManipulators();__parentControl;__destroyOnParentDestroy=[];constructor(displaysOrParentControl,parentControl){this.__displays=new Set(displaysOrParentControl&&window.Symbol.iterator in displaysOrParentControl?displaysOrParentControl:null),this.__parentControl=displaysOrParentControl instanceof TcHmi.Controls.System.TcHmiControl?displaysOrParentControl:parentControl,this.__parentControl&&this.__destroyOnParentDestroy.push(TcHmi.EventProvider.register(this.__parentControl.getId()+".onDetached",()=>{this.__suspended||(this.suspend(),this.__autoSuspended=!0)}),TcHmi.EventProvider.register(this.__parentControl.getId()+".onAttached",()=>{this.__autoSuspended&&(this.resume(),this.__autoSuspended=!1)}),TcHmi.EventProvider.register(this.__parentControl.getId()+".onDestroyed",()=>{this.suspend();for(let destroyer of this.__destroyOnParentDestroy)destroyer();this.__destroyOnParentDestroy=[]}))}addDisplay(display){this.__displays.add(display),display.setDirectory(this.__directory)}removeDisplay(display){this.__displays.delete(display)&&display.suspend(!0)}suspend(clear=!1){if(!this.__suspended){for(const display of this.__displays)display.suspend(clear);this.__directory=null,this.__suspended=!0}}resume(){if(this.__suspended){this.__suspended=!1;for(const display of this.__displays)display.resume()}}suspendDirectoryUpdates(){this.__directoryUpdatesSuspension.suspended||(this.__directoryUpdatesSuspension.suspended=!0)}resumeDirectoryUpdates(){this.__directoryUpdatesSuspension.suspended&&(this.__directoryUpdatesSuspension.suspended=!1,void 0!==this.__directoryUpdatesSuspension.cachedUpdate&&(this.__updateDirectory(this.__directoryUpdatesSuspension.cachedUpdate),this.__directoryUpdatesSuspension.cachedUpdate=void 0))}getCurrentItem(){return this.__directory?this.__directory.currentItem:null}getCurrentFolder(){return this.__directory?this.__directory.currentFolder:null}getPath(){return this.__directory?tchmi_clone_object(this.__directory.path):null}getFolderPath(){return this.__directory?this.__directory.currentItem.type===DirectoryBrowser.ItemType.Folder?tchmi_clone_object(this.__directory.path):this.__directory.path.slice(0,-1):null}getSelectedItems(){return this.__directory?this.__directory.selectedItems:null}setPath(value){return this.__pathToSet&&(this.__pathToSet=null),this.__directory?this.__directory.setPathAndValidate(tchmi_clone_object(value)):new Promise(resolve=>{this.__pathToSet={path:tchmi_clone_object(value),callback:resolve}})}selectItem(name,expandSelection){if(!expandSelection){for(const itemToSelect of this.__itemsToSelect)itemToSelect.callback(!1);this.__itemsToSelect=[]}return this.__directory?this.__directory.selectItem(name,expandSelection):new Promise(resolve=>{this.__itemsToSelect.push({itemName:name,callback:resolve})})}deselectItem(name){if(this.__directory)return this.__directory.deselectItem(name);const index=this.__itemsToSelect.findIndex(itemToSelect=>itemToSelect.itemName===name);return-1!==index?(this.__itemsToSelect[index].callback(!1),this.__itemsToSelect.splice(index,1),Promise.resolve(!0)):Promise.resolve(!1)}clearSelection(){if(this.__directory)return this.__directory.clearSelection();for(const item of this.__itemsToSelect)item.callback(!1);return this.__itemsToSelect=[],Promise.resolve(!0)}fakeFile(path,payload,metadata){this.__fakeFile&&tchmi_equal(this.__fakeFile.path,path)&&tchmi_equal(this.__fakeFile.payload,payload)&&tchmi_equal(this.__fakeFile.metadata,metadata)||(this.__fakeFile={path,payload,metadata,remove:()=>this.__directory?.root??null},this.__updateDirectory(this.__directory?.root??null))}clearFakedFile(){if(!this.__fakeFile)return;const unfaked=this.__fakeFile.remove();this.__fakeFile=null,this.__updateDirectory(unfaked)}hasFakedFile(){return null!==this.__fakeFile}setNavigationToFilesAllowed(value){this.__directory&&(this.__directory.navigationToFilesAllowed=value),this.__navigationToFilesAllowedCache=value}getNavigationToFilesAllowed(){return this.__directory?.navigationToFilesAllowed??this.__navigationToFilesAllowedCache}setMultiSelectAllowed(value){this.__directory&&(this.__directory.multiSelectAllowed=value),this.__multiSelectAllowedCache=value}getMultiSelectAllowed(){return this.__directory?.multiSelectAllowed??this.__multiSelectAllowedCache}async __onBeforePathChange(newCurrentItem,path,cancelable){if(!this.__directory)return!1;return!(await this.__onBeforePathChangeManager.trigger(newCurrentItem,tchmi_clone_object(path),cancelable)).some(result=>"fulfilled"===result.status&&!result.value)}async __onBeforeSelectionChange(newSelectedItems,cancelable){if(!this.__directory)return!1;return!(await this.__onBeforeSelectionChangeManager.trigger(newSelectedItems,cancelable)).some(result=>"fulfilled"===result.status&&!result.value)}__onSelectionChange(newSelectedItems){this.__directory&&this.__onSelectionChangeManager.trigger(newSelectedItems)}__onSelectedItemUpdate(selectedItem){this.__directory&&this.__onSelectedItemUpdateManager.trigger(selectedItem)}__onPathChange(currentItem,path){this.__directory&&this.__onPathChangeManager.trigger(currentItem,tchmi_clone_object(path))}__onCurrentItemChange(currentItem){this.__directory&&this.__onCurrentItemUpdateManager.trigger(currentItem)}setDirectory(rootFolder,getChildren,isFile,getMetadata){const directory=null===rootFolder?null:this.buildDirectoryTree(rootFolder,getChildren,isFile,getMetadata);return this.__updateDirectory(directory)}async __updateDirectory(directory){if(this.__directoryUpdatesSuspension.suspended)this.__directoryUpdatesSuspension.cachedUpdate=directory;else{if(this.__fakeFile&&this.__fakeFile.path.length>0){let removeFunction=null;directory||(directory={type:DirectoryBrowser.ItemType.Root,payload:void 0,children:new Map},removeFunction=()=>null);let current=directory,abort=!1;for(const name of this.__fakeFile.path.slice(0,-1)){let next=current.children.get(name);if(next||(next={type:DirectoryBrowser.ItemType.Folder,name,payload:void 0,parent:current,children:new Map},current.children.set(name,next),removeFunction||(removeFunction=()=>(next.parent.children.delete(name),directory))),next.type===DirectoryBrowser.ItemType.File){abort=!0;break}current=next}const filename=this.__fakeFile.path[this.__fakeFile.path.length-1];abort||current.children.has(filename)||(current.children.set(filename,{type:DirectoryBrowser.ItemType.File,name:filename,parent:current,payload:this.__fakeFile.payload,metadata:this.__fakeFile.metadata}),removeFunction||(removeFunction=()=>(current.children.delete(filename),directory)),this.__fakeFile.remove=removeFunction)}if(directory)if(this.__directory)await this.__directory.setRootAndValidate(directory);else{this.__directory=new DirectoryBrowser.Directory(directory),this.__directory.navigationToFilesAllowed=this.__navigationToFilesAllowedCache,this.__directory.multiSelectAllowed=this.__multiSelectAllowedCache;for(const display of this.__displays)display.setDirectory(this.__directory);this.__directory.onBeforePathChange.add(this.__onBeforePathChange),this.__directory.onBeforeSelectionChange.add(this.__onBeforeSelectionChange),this.__directory.onSelectionChange.add(this.__onSelectionChange),this.__directory.onSelectedItemUpdate.add(this.__onSelectedItemUpdate),this.__directory.onPathChange.add(this.__onPathChange),this.__directory.onCurrentItemUpdate.add(this.__onCurrentItemChange),this.__pathToSet&&(this.__pathToSet.callback(this.__directory.setPathAndValidate(this.__pathToSet.path)),this.__pathToSet=null);for(const itemToSelect of this.__itemsToSelect)itemToSelect.callback(this.__directory.selectItem(itemToSelect.itemName,!0));this.__itemsToSelect=[]}else if(this.__directory){await this.__onBeforePathChangeManager.trigger(null,null,!1),await this.__onBeforeSelectionChangeManager.trigger(null,!1),this.__directory&&(this.__directory.onBeforePathChange.remove(this.__onBeforePathChange),this.__directory.onBeforeSelectionChange.remove(this.__onBeforeSelectionChange),this.__directory.onSelectionChange.remove(this.__onSelectionChange),this.__directory.onSelectedItemUpdate.remove(this.__onSelectedItemUpdate),this.__directory.onPathChange.remove(this.__onPathChange),this.__directory.onCurrentItemUpdate.remove(this.__onCurrentItemChange),this.__directory=null),this.__onSelectionChangeManager.trigger(null),this.__onPathChangeManager.trigger(null,null);for(const display of this.__displays)display.setDirectory(null)}}}buildDirectoryTree(rootFolder,getChildren,isFile,getMetadata){const buildTree=root=>{for(const[name,childPayload]of getChildren(root.payload))if(isFile(childPayload)){const child={type:DirectoryBrowser.ItemType.File,name,payload:childPayload,parent:root};getMetadata&&(child.metadata=getMetadata(childPayload)),root.children.set(name,child)}else{const child={type:DirectoryBrowser.ItemType.Folder,name,payload:childPayload,parent:root,children:new Map};getMetadata&&(child.metadata=getMetadata(childPayload)),buildTree(child),root.children.set(name,child)}},root={type:DirectoryBrowser.ItemType.Root,payload:rootFolder,children:new Map};return buildTree(root),root}}})();Helpers.DirectoryBrowser=DirectoryBrowser,function(DirectoryBrowser){let ItemType;!function(ItemType){ItemType[ItemType.File=0]="File",ItemType[ItemType.Folder=1]="Folder",ItemType[ItemType.Root=2]="Root"}(ItemType=DirectoryBrowser.ItemType||(DirectoryBrowser.ItemType={}));DirectoryBrowser.Directory=class{__root;__path=[];__currentItem;__selectedItems=[];__navigationToFilesAllowed=!0;__multiSelectAllowed=!1;__onBeforePathChangeManager=new Helpers.AsyncCallbackManager;onBeforePathChange=this.__onBeforePathChangeManager.getManipulators();__onBeforeSelectionChangeManager=new Helpers.AsyncCallbackManager;onBeforeSelectionChange=this.__onBeforeSelectionChangeManager.getManipulators();__onSelectionChangeManager=new Helpers.CallbackManager;onSelectionChange=this.__onSelectionChangeManager.getManipulators();__onSelectedItemUpdateManager=new Helpers.CallbackManager;onSelectedItemUpdate=this.__onSelectedItemUpdateManager.getManipulators();__onPathChangeManager=new Helpers.CallbackManager;onPathChange=this.__onPathChangeManager.getManipulators();__onCurrentItemUpdateManager=new Helpers.CallbackManager;onCurrentItemUpdate=this.__onCurrentItemUpdateManager.getManipulators();__onDirectoryUpdateManager=new Helpers.CallbackManager;onDirectoryUpdate=this.__onDirectoryUpdateManager.getManipulators();constructor(__root){this.__root=__root,this.__currentItem=__root}get root(){return this.__root}async setRootAndValidate(value){const validationResult=this.__validatePath(value,this.__path),selectedItems=[];if(validationResult.isValid)for(const selectedItem of this.__selectedItems){const path=DirectoryBrowser.getPath(selectedItem);let newSelectedItem=value;for(const name of path){if(!newSelectedItem||newSelectedItem.type===DirectoryBrowser.ItemType.File)break;newSelectedItem=newSelectedItem.children.get(name)}newSelectedItem&&newSelectedItem.type!==DirectoryBrowser.ItemType.Root&&selectedItems.push({old:selectedItem,new:newSelectedItem})}else await this.__onBeforePathChangeManager.trigger(validationResult.currentItem,tchmi_clone_object(validationResult.newPath),!1);if(selectedItems.length!==this.__selectedItems.length){const oldSelectedItems=selectedItems.map(entry=>entry.old);await this.__onBeforeSelectionChangeManager.trigger(oldSelectedItems,!1),this.__selectedItems=selectedItems.map(entry=>entry.new),this.__onSelectionChangeManager.trigger(this.__selectedItems)}const oldCurrentItem=this.currentItem;this.__root=value,this.__currentItem=validationResult.currentItem;for(const item of selectedItems)this.__itemsEquivalent(item.old,item.new)||this.__onSelectedItemUpdateManager.trigger(item.new);return validationResult.isValid?(this.__itemsEquivalent(oldCurrentItem,this.currentItem)||this.__onCurrentItemUpdateManager.trigger(this.__currentItem),this.__onDirectoryUpdateManager.trigger(this.__root),!0):(this.__path=validationResult.newPath,this.__onPathChangeManager.trigger(this.__currentItem,this.__path),this.__onDirectoryUpdateManager.trigger(this.__root),!1)}get path(){return this.__path}get decoratedPath(){const path=[];let current=this.__currentItem;for(;current.type!==ItemType.Root;)path.unshift(current),current=current.parent;return path.unshift(current),path}async setPathAndValidate(value,cancelable=!0){if(tchmi_equal(value,this.__path))return!0;const validationResult=this.__validatePath(this.__root,value);if(!validationResult.isValid)return!1;const results=await this.__onBeforePathChangeManager.trigger(validationResult.currentItem,tchmi_clone_object(value),cancelable);if(cancelable&&results.some(result=>"fulfilled"===result.status&&!result.value))return!1;const clearSelectionResult=await this.clearSelection(cancelable);return!(cancelable&&!clearSelectionResult)&&(this.__path=value,this.__currentItem=validationResult.currentItem,this.__onPathChangeManager.trigger(this.__currentItem,tchmi_clone_object(this.__path)),!0)}async pushPath(name,cancelable=!0){if(this.__currentItem.type===ItemType.File)return!1;const newCurrentItem=this.__currentItem.children.get(name);if(!newCurrentItem||newCurrentItem.type===ItemType.File&&!this.__navigationToFilesAllowed)return!1;const results=await this.__onBeforePathChangeManager.trigger(newCurrentItem,this.__path.concat(name),cancelable);if(cancelable&&results.some(result=>"fulfilled"===result.status&&!result.value))return!1;const clearSelectionResult=await this.clearSelection(cancelable);return!(cancelable&&!clearSelectionResult)&&(this.__path.push(name),this.__currentItem=newCurrentItem,this.__onPathChangeManager.trigger(this.__currentItem,tchmi_clone_object(this.__path)),!0)}async popPath(cancelable=!0){if(this.__currentItem.type===ItemType.Root)return null;const results=await this.__onBeforePathChangeManager.trigger(this.__currentItem.parent,this.__path.slice(0,-1),cancelable);if(cancelable&&results.some(result=>"fulfilled"===result.status&&!result.value))return null;const clearSelectionResult=await this.clearSelection(cancelable);if(cancelable&&!clearSelectionResult)return!1;const popped=this.__path.pop();return this.__currentItem=this.__currentItem.parent,this.__onPathChangeManager.trigger(this.__currentItem,tchmi_clone_object(this.__path)),popped??null}get currentItem(){return this.__currentItem}get currentFolder(){return this.__currentItem.type===ItemType.File?this.__currentItem.parent:this.__currentItem}get selectedItemNames(){return new Set(this.__selectedItems.filter(item=>item.parent===this.__currentItem).map(item=>item.name))}get selectedItems(){return[...this.__selectedItems]}async selectItem(itemOrName,expandSelection,cancelable=!0){const selectedItem="object"==typeof itemOrName?itemOrName:this.__currentItem.type!==ItemType.File?this.__currentItem.children.get(itemOrName):void 0;if(!selectedItem)return!1;if(this.selectedItems.includes(selectedItem)&&(expandSelection||1===this.__selectedItems.length))return!0;const selectedItems=(expandSelection=expandSelection&&this.__multiSelectAllowed)?this.selectedItems:[];selectedItems.push(selectedItem);const results=await this.__onBeforeSelectionChangeManager.trigger(selectedItems,cancelable);return(!cancelable||!results.some(result=>"fulfilled"===result.status&&!result.value))&&(this.__selectedItems=selectedItems,this.__onSelectionChangeManager.trigger(selectedItems),!0)}async deselectItem(itemOrName,cancelable=!0){const selectedItem="object"==typeof itemOrName?itemOrName:this.__currentItem.type!==ItemType.File?this.__currentItem.children.get(itemOrName):void 0;if(!selectedItem||!this.__selectedItems.includes(selectedItem))return!0;const selectedItems=this.__selectedItems.filter(item=>item!==selectedItem),results=await this.__onBeforeSelectionChangeManager.trigger(selectedItems,cancelable);return(!cancelable||!results.some(result=>"fulfilled"===result.status&&!result.value))&&(this.__selectedItems=selectedItems,this.__onSelectionChangeManager.trigger(selectedItems),!0)}async clearSelection(cancelable=!0){if(0===this.__selectedItems.length)return!0;const results=await this.__onBeforeSelectionChangeManager.trigger([],cancelable);return(!cancelable||!results.some(result=>"fulfilled"===result.status&&!result.value))&&(this.__selectedItems=[],this.__onSelectionChangeManager.trigger([]),!0)}set navigationToFilesAllowed(value){this.__navigationToFilesAllowed=value,this.__navigationToFilesAllowed||this.currentItem.type!==ItemType.File||this.popPath(!1)}get navigationToFilesAllowed(){return this.__navigationToFilesAllowed}set multiSelectAllowed(value){this.__multiSelectAllowed=value,!this.__multiSelectAllowed&&this.selectedItemNames.size>1&&this.clearSelection()}get multiSelectAllowed(){return this.__navigationToFilesAllowed}__validatePath(root,path){let current=root,valid=!0,index=0;for(;index<path.length;index++){if(current.type===ItemType.File){valid=!1;break}const name=path[index],next=current.children.get(name);if(!next||next.type===ItemType.File&&!this.__navigationToFilesAllowed){valid=!1;break}current=next}if(!valid){return{isValid:!1,newPath:path.slice(0,index),currentItem:current}}return{isValid:!0,currentItem:current}}__itemsEquivalent(a,b){if(a.type!==b.type)return!1;if(a.type!==ItemType.Root&&b.type!==ItemType.Root&&a.name!==b.name)return!1;if(a.type!==ItemType.File&&b.type!==ItemType.File){if(a.children.size!==b.children.size)return!1;const aIterator=a.children.entries(),bIterator=b.children.entries();let aStep=aIterator.next(),bStep=bIterator.next();for(;!aStep.done&&!bStep.done;){if(aStep.value[0]!==bStep.value[0])return!1;if(!this.__itemsEquivalent(aStep.value[1],bStep.value[1]))return!1;aStep=aIterator.next(),bStep=bIterator.next()}}else if(a.payload===b.payload||!tchmi_equal(a.payload,b.payload))return!1;return!(a.metadata===b.metadata||!tchmi_equal(a.metadata,b.metadata))}},DirectoryBrowser.compare=function(sort,a,b){for(const criterion of sort.sorting){const order="Descending"===criterion.order?-1:1;if(!criterion.name){if(a.type!==b.type)return(a.type===DirectoryBrowser.ItemType.File?1:-1)*order;const aName=sort.caseSensitive?a.name:a.name.toLowerCase(),bName=sort.caseSensitive?b.name:b.name.toLowerCase();if(aName!==bName)return(aName<bName?-1:1)*order;continue}const path=new TcHmi.ObjectPath(criterion.name);let aValue=path.readFrom(a),bValue=path.readFrom(b);if(null==aValue){if(null==bValue)continue;return-1*order}if(null==bValue){if(null==aValue)continue;return 1*order}aValue instanceof Date&&bValue instanceof Date&&(aValue=aValue.getTime(),bValue=bValue.getTime());const aType=typeof aValue,bType=typeof bValue;if(aType!==bType)switch(aType){case"boolean":switch(bType){case"number":case"bigint":aValue=aValue?1:0;break;case"string":aValue=aValue.toString();break;default:continue}break;case"number":case"bigint":switch(bType){case"boolean":bValue=bValue?1:0;break;case"number":case"bigint":break;case"string":aValue=aValue.toString();break;default:continue}break;case"string":switch(bType){case"boolean":case"number":case"bigint":bValue=bValue.toString();break;default:continue}break;default:continue}if(sort.caseSensitive||"string"!=typeof aValue||"string"!=typeof bValue||(aValue=aValue.toLowerCase(),bValue=bValue.toLowerCase()),aValue!==bValue)return(aValue<bValue?-1:1)*order}return 0},DirectoryBrowser.getPath=function(item){const path=[];for(;item.type!==DirectoryBrowser.ItemType.Root;)path.unshift(item.name),item=item.parent;return path}}(DirectoryBrowser=Helpers.DirectoryBrowser||(Helpers.DirectoryBrowser={}))}(Controls.Helpers||(Controls.Helpers={}))}(TcHmi.Controls||(TcHmi.Controls={}))}(TcHmi||(TcHmi={}));