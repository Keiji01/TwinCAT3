var __runInitializers=this&&this.__runInitializers||function(thisArg,initializers,value){for(var useValue=arguments.length>2,i=0;i<initializers.length;i++)value=useValue?initializers[i].call(thisArg,value):initializers[i].call(thisArg);return useValue?value:void 0},__esDecorate=this&&this.__esDecorate||function(ctor,descriptorIn,decorators,contextIn,initializers,extraInitializers){function accept(f){if(void 0!==f&&"function"!=typeof f)throw new TypeError("Function expected");return f}for(var _,kind=contextIn.kind,key="getter"===kind?"get":"setter"===kind?"set":"value",target=!descriptorIn&&ctor?contextIn.static?ctor:ctor.prototype:null,descriptor=descriptorIn||(target?Object.getOwnPropertyDescriptor(target,contextIn.name):{}),done=!1,i=decorators.length-1;i>=0;i--){var context={};for(var p in contextIn)context[p]="access"===p?{}:contextIn[p];for(var p in contextIn.access)context.access[p]=contextIn.access[p];context.addInitializer=function(f){if(done)throw new TypeError("Cannot add initializers after decoration has completed");extraInitializers.push(accept(f||null))};var result=(0,decorators[i])("accessor"===kind?{get:descriptor.get,set:descriptor.set}:descriptor[key],context);if("accessor"===kind){if(void 0===result)continue;if(null===result||"object"!=typeof result)throw new TypeError("Object expected");(_=accept(result.get))&&(descriptor.get=_),(_=accept(result.set))&&(descriptor.set=_),(_=accept(result.init))&&initializers.unshift(_)}else(_=accept(result))&&("field"===kind?initializers.unshift(_):descriptor[key]=_)}target&&Object.defineProperty(target,contextIn.name,descriptor),done=!0};import{SyncCmdToCreatorControlDoubleClick}from"./SyncCmdToCreatorControlDoubleClick.js";import{SyncCmdToCreatorCopyMoveControls}from"./SyncCmdToCreatorCopyMoveControls.js";import{SyncCmdToCreatorHierarchyMoveControls}from"./SyncCmdToCreatorHierarchyMoveControls.js";import{metaDataManager}from"./DesignerModeControlMetaDataMngr.js";import{rootControlManager}from"./DesignerModeMasterRootControlMngr.js";import{interactionManager}from"./DesignerModeMasterInteractionMngr.js";import{hierarchyManager}from"./DesignerModeMasterHierarchyMngr.js";import{controlResizeManager}from"./DesignerModeMasterControlResizeMngr.js";import{rectSelectManager}from"./DesignerModeMasterRectSelectMngr.js";import{syncManager}from"./DesignerModeMasterSyncManager.js";import{designerModeManager}from"./DesignerModeManager.js";import{highlightManager}from"./DesignerModeMasterControlHighlightMngr.js";TCHMI_DESIGNER||TcHmi.Log.errorEx(`Internal error: The file "${import.meta.url}" is restricted to use within the designer.`);let DesignerModeMasterControlMoveManager=(()=>{var _a,_b,_c;let ___onHighlightMouseDown_decorators,___onHighlightMouseMove_decorators,___onHighlightMouseUp_decorators,_instanceExtraInitializers=[];return class{static{const _metadata="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;___onHighlightMouseDown_decorators=[(_a=TcHmi).CallbackMethod.bind(_a)],___onHighlightMouseMove_decorators=[(_b=TcHmi).CallbackMethod.bind(_b)],___onHighlightMouseUp_decorators=[(_c=TcHmi).CallbackMethod.bind(_c)],__esDecorate(this,null,___onHighlightMouseDown_decorators,{kind:"method",name:"__onHighlightMouseDown",static:!1,private:!1,access:{has:obj=>"__onHighlightMouseDown"in obj,get:obj=>obj.__onHighlightMouseDown},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onHighlightMouseMove_decorators,{kind:"method",name:"__onHighlightMouseMove",static:!1,private:!1,access:{has:obj=>"__onHighlightMouseMove"in obj,get:obj=>obj.__onHighlightMouseMove},metadata:_metadata},null,_instanceExtraInitializers),__esDecorate(this,null,___onHighlightMouseUp_decorators,{kind:"method",name:"__onHighlightMouseUp",static:!1,private:!1,access:{has:obj=>"__onHighlightMouseUp"in obj,get:obj=>obj.__onHighlightMouseUp},metadata:_metadata},null,_instanceExtraInitializers),_metadata&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_metadata})}constructor(){this.__copyMoveRectHighlighter=document.createElement("canvas"),this.__copyMoveRectHighlighter.classList.add("tchmi-creator-copymove-container"),this.__onHighlightMouseUpLastProc=Date.now()}__copyMoveRectHighlighter=__runInitializers(this,_instanceExtraInitializers);__copyMoveRectHighlightOffset={left:0,top:0};__highlightMouseDownNs="mousedown.DesignerModeManager.HighlightMouseDown";__highlightMouseUpNs="mouseup.DesignerModeManager.HighlightMouseUp";__highlightMouseMoveNs="mousemove.DesignerModeManager.HighlightMouseMove";__activeControl=null;__activeControlPrev=null;__mouseMoving=!1;__lockControlMove=!1;__controlMoveActive=!1;__onHighlightMouseUpLastProc;registerControl(ctrlMeta){ctrlMeta.jControlPosition.on(this.__highlightMouseDownNs,this.__onHighlightMouseDown)}getActiveControl(){return this.__activeControl}getActiveControlPrev(){return this.__activeControlPrev}getControlMoveActive(){return this.__controlMoveActive}lockControlMove(){this.__lockControlMove=!0}setMouseMoving(valueNew){this.__mouseMoving=valueNew}resetState(){this.__lockControlMove=!1,this.__controlMoveActive=!1,TcHmi.System.SharedResources.jqDocument.off(this.__highlightMouseMoveNs),TcHmi.System.SharedResources.jqDocument.off(this.__highlightMouseUpNs),document.body.style.cursor="",hierarchyManager.removeHighlightDropTarget(),this.__copyMoveRectHighlighter.remove(),null!==this.__activeControl&&(this.__activeControl.jOriginalPosition[0].classList.remove("tchmi-creator-control-snaptop"),this.__activeControl.jOriginalPosition[0].classList.remove("tchmi-creator-control-snapleft"),this.__activeControl.jOriginalPosition[0].classList.remove("tchmi-creator-control-snapbottom"),this.__activeControl.jOriginalPosition[0].classList.remove("tchmi-creator-control-snapright"),this.__activeControl.jOriginalPosition[0].classList.remove("tchmi-creator-control-snaptop-remote"),this.__activeControl.jOriginalPosition[0].classList.remove("tchmi-creator-control-snapleft-remote"),this.__activeControl.jOriginalPosition[0].classList.remove("tchmi-creator-control-snapbottom-remote"),this.__activeControl.jOriginalPosition[0].classList.remove("tchmi-creator-control-snapright-remote"))}__onHighlightMouseDown(event){if(1!==event.which)return;let targetControl=$(event.target).attr("data-tchmi-creator-target-control");if(!targetControl)return;const acNew=metaDataManager.getControlMetaData(targetControl);acNew&&(this.__activeControlPrev=this.__activeControl,this.__activeControl=acNew,interactionManager.handleInteractionStart(event,acNew),interactionManager.handleInteractionStartCopyMoveOffsetPosition(event),interactionManager.setAnchorName(void 0),this.__lockControlMove=!1,TcHmi.System.SharedResources.jqDocument.on(this.__highlightMouseMoveNs,this.__onHighlightMouseMove),TcHmi.System.SharedResources.jqDocument.on(this.__highlightMouseUpNs,this.__onHighlightMouseUp))}__selectedControlsSameParent(preventPointerEvents){if(!this.__activeControl)return null;let selectedControls=[];null===this.__activeControl.parent&&(selectedControls=null);const newCssPointerEvent=preventPointerEvents?"none":"",selectedControlsMeta=metaDataManager.getSelectedControlsMetaData();for(const ctrlMeta of selectedControlsMeta.values())null!==preventPointerEvents&&(ctrlMeta.jControlPosition[0].style.pointerEvents=newCssPointerEvent,TcHmi.StyleProvider.setSimpleElementStyle(ctrlMeta.jControlPosition[0].querySelectorAll("*"),"pointer-events",newCssPointerEvent),ctrlMeta.jHierarchyControlposition[0].style.pointerEvents=newCssPointerEvent,TcHmi.StyleProvider.setSimpleElementStyle(ctrlMeta.jHierarchyControlposition[0].querySelectorAll("*"),"pointer-events",newCssPointerEvent)),null!==ctrlMeta.parent&&ctrlMeta.parent.id===this.__activeControl.parent.id?selectedControls&&selectedControls.push(ctrlMeta.id):selectedControls=null;return selectedControls}__onHighlightMouseMove(event){if(null===this.__activeControl)return;if(controlResizeManager.getControlResizing())return;if(this.__activeControl.isPartialRoot)return;if(rectSelectManager.getRectSelecting())return;if(this.__lockControlMove)return;if(void 0===event.pageX||void 0===event.pageY)return;const startMousePosition=interactionManager.getStartMousePos(),startMousePositionCopyMoveOffsetPosition=interactionManager.getStartMousePosCopyMoveOffsetPosition();let deltaLeft=event.pageX-startMousePosition.left,deltaTop=event.pageY-startMousePosition.top;if(!0===event.ctrlKey&&this.__activeControl.isContainerControl&&deltaLeft<10&&deltaTop<10){let temp=this.__activeControl;for(;temp;)designerModeManager.unselect({controlId:temp.id,bIgnoreSync:!0}),temp=temp.parent;return}if(1!==event.which)return void this.resetState();let iterateMeta=this.__activeControl;do{if(iterateMeta.locked)return;iterateMeta=iterateMeta.parent}while(iterateMeta);if(!this.__mouseMoving){if(!1===event.ctrlKey&&!this.__activeControl.isSelected){const selectedControlsMeta=metaDataManager.getSelectedControlsMetaData();for(let ctrlMeta of selectedControlsMeta.values())ctrlMeta&&null!==this.__activeControl&&ctrlMeta.id!==this.__activeControl.id&&designerModeManager.unselect({controlId:ctrlMeta.id,bIgnoreSync:!0,rebuildCacheAndClasses:"none"})}designerModeManager.select({controlId:this.__activeControl.id,bIgnoreSync:!0,rebuildCacheAndClasses:"all"})}let directionLock="none";if(0!==deltaLeft||0!==deltaTop){if(this.__mouseMoving=!0,!0===event.shiftKey&&(Math.abs(deltaLeft)>Math.abs(deltaTop)?(deltaTop=0,directionLock="topBottom"):(deltaLeft=0,directionLock="leftRight")),this.__controlMoveActive=!0,rectSelectManager.lockRectSelect(),!1===event.ctrlKey){const creatorZoomFactor=rootControlManager.getCreatorZoomFactor();let snappedDelta=interactionManager.handleSnapping(this.__activeControl,{left:deltaLeft/creatorZoomFactor,top:deltaTop/creatorZoomFactor},{left:event.pageX,top:event.pageY},!event.altKey,directionLock);this.__copyMoveRectHighlighter.parentElement&&(document.body.style.cursor="",this.__copyMoveRectHighlighter.remove());const ctrlList=[],selectedControlsMeta=metaDataManager.getSelectedControlsMetaData();for(const ctrlMeta of selectedControlsMeta.values()){if(ctrlMeta.isPartialRoot)continue;this.__processMove(ctrlMeta,snappedDelta);const tco=TcHmi.Controls.get(ctrlMeta.id);tco&&ctrlList.push(tco)}hierarchyManager.removeHighlightDropTarget();if(null!==this.__selectedControlsSameParent(!0)){const currentDropTarget=hierarchyManager.getContainerFromPoint({left:event.pageX,top:event.pageY});if(currentDropTarget){let tco=TcHmi.Controls.get(this.__activeControl.id);const parentId=this.__activeControl.parent?this.__activeControl.parent.id:"";tco&&(!0!==event.altKey&&parentId!==currentDropTarget.tco.getId()?(hierarchyManager.addHighlightDropTarget({left:event.pageX,top:event.pageY},event.target),this.__activeControl.jControlPosition[0].classList.add("tchmi-creator-will-get-new-parent"),this.__activeControl.jOriginalPosition[0].classList.add("tchmi-creator-will-get-new-parent")):!0===event.altKey||!this.__activeControl.parent?.isGridControl||currentDropTarget.columnIndex===tco.getGridColumnIndex()&&currentDropTarget.rowIndex===tco.getGridRowIndex()?(this.__activeControl.jControlPosition[0].classList.remove("tchmi-creator-will-get-new-parent"),this.__activeControl.jOriginalPosition[0].classList.remove("tchmi-creator-will-get-new-parent")):(hierarchyManager.addHighlightDropTarget({left:event.pageX,top:event.pageY},event.target),this.__activeControl.jControlPosition[0].classList.add("tchmi-creator-will-get-new-parent"),this.__activeControl.jOriginalPosition[0].classList.add("tchmi-creator-will-get-new-parent")))}}highlightManager.setContainerPositions(new Set(ctrlList)),this.__selectedControlsSameParent(!1)}else if(Math.abs(deltaLeft)>=5&&Math.abs(deltaTop)>=5)if(this.__copyMoveRectHighlighter.parentElement){let startMouseOffsetTop=startMousePosition.top-startMousePositionCopyMoveOffsetPosition.top,startMouseOffsetLeft=startMousePosition.left-startMousePositionCopyMoveOffsetPosition.left;this.__copyMoveRectHighlighter.style.top=this.__copyMoveRectHighlightOffset.top+deltaTop+window.scrollY+startMouseOffsetTop+"px",this.__copyMoveRectHighlighter.style.left=this.__copyMoveRectHighlightOffset.left+deltaLeft+window.scrollX+startMouseOffsetLeft+"px",hierarchyManager.addHighlightDropTarget({left:event.pageX,top:event.pageY},event.target)}else{this.__activeControl.jOriginalPosition[0].classList.remove("tchmi-creator-control-snaptop"),this.__activeControl.jOriginalPosition[0].classList.remove("tchmi-creator-control-snapleft"),this.__activeControl.jOriginalPosition[0].classList.remove("tchmi-creator-control-snapbottom"),this.__activeControl.jOriginalPosition[0].classList.remove("tchmi-creator-control-snapright"),this.__activeControl.jOriginalPosition[0].classList.remove("tchmi-creator-control-snaptop-remote"),this.__activeControl.jOriginalPosition[0].classList.remove("tchmi-creator-control-snapleft-remote"),this.__activeControl.jOriginalPosition[0].classList.remove("tchmi-creator-control-snapbottom-remote"),this.__activeControl.jOriginalPosition[0].classList.remove("tchmi-creator-control-snapright-remote");let combinedBounding={top:Number.POSITIVE_INFINITY,left:Number.POSITIVE_INFINITY,rightside:Number.NEGATIVE_INFINITY,bottomside:Number.NEGATIVE_INFINITY},validSelection=!0;null===this.__activeControl.parent&&(validSelection=!1);let controlOutlineList=[];const selectedControlsMeta=metaDataManager.getSelectedControlsMetaData(),ctrlList=[];for(const ctrlMeta of selectedControlsMeta.values()){if(TcHmi.StyleProvider.setSimpleElementStyle(ctrlMeta.jControlPosition,"pointer-events","none"),!validSelection)continue;if(null===ctrlMeta.parent){validSelection=!1;continue}if(ctrlMeta.parent.id!==this.__activeControl.parent.id){validSelection=!1;continue}let ctrlBB=ctrlMeta.jControlPosition[0].getBoundingClientRect();combinedBounding.top>ctrlBB.top&&(combinedBounding.top=ctrlBB.top),combinedBounding.left>ctrlBB.left&&(combinedBounding.left=ctrlBB.left),combinedBounding.bottomside<ctrlBB.top+ctrlBB.height&&(combinedBounding.bottomside=ctrlBB.top+ctrlBB.height),combinedBounding.rightside<ctrlBB.left+ctrlBB.width&&(combinedBounding.rightside=ctrlBB.left+ctrlBB.width),controlOutlineList.push({top:ctrlBB.top,left:ctrlBB.left,height:ctrlBB.height,width:ctrlBB.width});const tco=TcHmi.Controls.get(ctrlMeta.id);tco&&ctrlList.push(tco),this.__processMove(ctrlMeta,{left:0,top:0})}if(highlightManager.setContainerPositions(new Set(ctrlList)),interactionManager.handleInteractionStartCopyMoveOffsetPosition(event),hierarchyManager.addHighlightDropTarget({left:event.pageX,top:event.pageY},event.target),validSelection){document.body.style.cursor="copy",this.__copyMoveRectHighlightOffset.top=combinedBounding.top,this.__copyMoveRectHighlightOffset.left=combinedBounding.left;let pageBoundingTop=combinedBounding.top+deltaTop+window.scrollY,pageBoundingLeft=combinedBounding.left+deltaLeft+window.scrollX,boundingHeight=combinedBounding.bottomside-combinedBounding.top,boundingWidth=combinedBounding.rightside-combinedBounding.left;this.__copyMoveRectHighlighter.width=boundingWidth,this.__copyMoveRectHighlighter.height=boundingHeight,this.__copyMoveRectHighlighter.style.top=pageBoundingTop+"px",this.__copyMoveRectHighlighter.style.left=pageBoundingLeft+"px",this.__copyMoveRectHighlighter.style.height=boundingHeight+"px",this.__copyMoveRectHighlighter.style.width=boundingWidth+"px";const ctx=this.__copyMoveRectHighlighter.getContext("2d");if(ctx){ctx.strokeStyle="gray";for(let ctrlOutline of controlOutlineList)void 0!==ctrlOutline.left&&void 0!==ctrlOutline.top&&void 0!==ctrlOutline.width&&void 0!==ctrlOutline.height&&ctx.strokeRect(ctrlOutline.left+window.scrollX+deltaLeft-pageBoundingLeft,ctrlOutline.top+window.scrollY+deltaTop-pageBoundingTop,ctrlOutline.width,ctrlOutline.height);document.body.appendChild(this.__copyMoveRectHighlighter)}}else document.body.style.cursor="no-drop";for(const ctrlMeta of selectedControlsMeta.values())TcHmi.StyleProvider.setSimpleElementStyle(ctrlMeta.jControlPosition,"pointer-events","")}}else rectSelectManager.lockRectSelect()}__processMove(ctrlMeta,delta){if(!ctrlMeta.controlAttributeDimension||void 0===ctrlMeta.absoluteParentRotation||void 0===ctrlMeta.relativeControlRotation)return;let deltaLeft=delta.left,deltaTop=delta.top,iterateMeta=ctrlMeta,breakLoop=!1;do{if(iterateMeta.locked){breakLoop=!0;break}iterateMeta=iterateMeta.parent}while(iterateMeta);if(breakLoop)return;const tco=TcHmi.Controls.get(ctrlMeta.id);if(!tco)return void TcHmi.Log.error(`Failed to move control "${ctrlMeta.id}": Not found in control cache.\n`);let parental_lock=!1,jParentControls=tco.getElement().parents("[data-tchmi-type]");const selectedControlIdsWithChildren=metaDataManager.getSelectedControlIdsWithChildren();for(let k=0,kk=jParentControls.length;k<kk;k++)if(selectedControlIdsWithChildren.includes(jParentControls[k].id)){parental_lock=!0;break}if(parental_lock)return;let potentialNewSize,parentDimension=null,newStyle={};null!==ctrlMeta.controlAttributeDimension.topValue&&("%"!==ctrlMeta.controlAttributeDimension.topUnit?(potentialNewSize=ctrlMeta.controlAttributeDimension.topValue+Math.sin(-ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaLeft+Math.cos(-ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaTop,newStyle.top=Math.round(potentialNewSize)+"px"):(null===parentDimension&&(parentDimension=tco.getElement().parent().outerHeight()??1),potentialNewSize=ctrlMeta.controlAttributeDimension.topValue+100*(Math.sin(-ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaLeft+Math.cos(-ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaTop)/parentDimension,newStyle.top=potentialNewSize+"%")),null!==ctrlMeta.controlAttributeDimension.bottomValue&&("%"!==ctrlMeta.controlAttributeDimension.bottomUnit?(potentialNewSize=ctrlMeta.controlAttributeDimension.bottomValue-Math.sin(-ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaLeft-Math.cos(-ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaTop,newStyle.bottom=Math.round(potentialNewSize)+"px"):(null===parentDimension&&(parentDimension=tco.getElement().parent().outerHeight()??1),potentialNewSize=ctrlMeta.controlAttributeDimension.bottomValue+100*(-Math.sin(-ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaLeft-Math.cos(-ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaTop)/parentDimension,newStyle.bottom=potentialNewSize+"%")),null===ctrlMeta.controlAttributeDimension.topValue&&null===ctrlMeta.controlAttributeDimension.bottomValue&&(newStyle.top=Math.round(Math.sin(-ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaLeft+Math.cos(-ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaTop)+"px"),parentDimension=null,null!==ctrlMeta.controlAttributeDimension.leftValue&&("%"!==ctrlMeta.controlAttributeDimension.leftUnit?(potentialNewSize=ctrlMeta.controlAttributeDimension.leftValue+Math.cos(ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaLeft+Math.sin(ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaTop,newStyle.left=Math.round(potentialNewSize)+"px"):(null===parentDimension&&(parentDimension=tco.getElement().parent().outerWidth()??1),potentialNewSize=ctrlMeta.controlAttributeDimension.leftValue+100*(Math.cos(ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaLeft+Math.sin(ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaTop)/parentDimension,newStyle.left=potentialNewSize+"%")),null!==ctrlMeta.controlAttributeDimension.rightValue&&("%"!==ctrlMeta.controlAttributeDimension.rightUnit?(potentialNewSize=ctrlMeta.controlAttributeDimension.rightValue-Math.cos(ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaLeft-Math.sin(ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaTop,newStyle.right=Math.round(potentialNewSize)+"px"):(null===parentDimension&&(parentDimension=tco.getElement().parent().outerWidth()??1),potentialNewSize=ctrlMeta.controlAttributeDimension.rightValue+100*(-Math.cos(ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaLeft-Math.sin(ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaTop)/parentDimension,newStyle.right=potentialNewSize+"%")),null===ctrlMeta.controlAttributeDimension.leftValue&&null===ctrlMeta.controlAttributeDimension.rightValue&&(newStyle.left=Math.round(Math.cos(ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaLeft+Math.sin(ctrlMeta.absoluteParentRotation*Math.PI/180)*deltaTop)+"px"),TcHmi.StyleProvider.setSimpleElementStyle(tco.getElement(),newStyle),metaDataManager.addChangedControlsMetaData(ctrlMeta);const tcoParent=tco.getParent();tcoParent&&ctrlMeta.parent&&ctrlMeta.parent.isGridControl&&highlightManager.setContainerPositions(new Set([tcoParent]))}__onHighlightMouseUp(event){if(void 0===event.pageX||void 0===event.pageY)return;const ac=this.__activeControl,acPrev=this.__activeControlPrev;if(!ac||!ac.controlAttributeDimension||void 0===ac.absoluteParentRotation||void 0===ac.relativeControlRotation)return;if(1!==event.which){if(3===event.which&&this.__controlMoveActive){const selectedControlsMeta=metaDataManager.getSelectedControlsMetaData(),controlMap=TcHmi.System.Services.controlManager.getControlsCache();for(const ctrlMeta of selectedControlsMeta.values()){if(ctrlMeta.isPartialRoot)continue;this.__processMove(ctrlMeta,{left:0,top:0});const control=controlMap.get(ctrlMeta.id);control&&highlightManager.requestAsyncHighlighterUpdateForControl(control)}}return void this.resetState()}if(this.__lockControlMove&&rectSelectManager.getRectSelecting())return void this.resetState();if(null===this.__activeControl)return this.__mouseMoving=!1,void this.resetState();this.__mouseMoving||(!1!==event.ctrlKey||ac.isSelected||designerModeManager.unselectEach({bIgnoreSync:!0,rebuildCacheAndClasses:"none"}),designerModeManager.select({controlId:ac.id,bIgnoreSync:!0,rebuildCacheAndClasses:"all"}),rectSelectManager.lockRectSelect());const startMousePosition=interactionManager.getStartMousePos(),deltaLeft=event.pageX-startMousePosition.left,deltaTop=event.pageY-startMousePosition.top;let interactionState=0;null!=acPrev&&ac.id===acPrev.id&&Math.abs(deltaLeft)<5&&Math.abs(deltaTop)<5&&Date.now()-this.__onHighlightMouseUpLastProc<=500&&(interactionState=3),this.__onHighlightMouseUpLastProc=Date.now();let activeTco=TcHmi.Controls.get(this.__activeControl.id);if(3===interactionState&&event.ctrlKey&&activeTco){let module=TcHmi.System.Data.Modules.controls.map.get(activeTco.getType());module&&module.error===TcHmi.Errors.NONE&&module.descriptionExpanded&&!module.descriptionExpanded.defaultDesignerEvent&&(interactionState=0)}if(3===interactionState)activeTco&&new SyncCmdToCreatorControlDoubleClick({name:"ControlDoubleClick",frameworkType:TCHMI_DESIGNER?"Designer":"LiveView",targetPartial:TCHMI_TARGET_PARTIAL,targetControl:{id:ac.id,type:activeTco.getType()},replyTo:null}).send();else{let command;!0===event.ctrlKey&&!this.__mouseMoving&&ac.isSelectedPrev&&ac.isSelected&&designerModeManager.unselect({controlId:ac.id,bIgnoreSync:!0}),!0===event.ctrlKey&&(Math.abs(deltaLeft)>5||Math.abs(deltaTop)>5)?interactionState=2:!0!==event.altKey&&(Math.abs(deltaLeft)>5||Math.abs(deltaTop)>5)&&(interactionState=1),null===ac.parent&&(interactionState=0);let dropConfig,controls=null;if(0!==interactionState&&(controls=this.__selectedControlsSameParent(!0),dropConfig=hierarchyManager.getContainerFromPoint({left:event.pageX,top:event.pageY}),this.__selectedControlsSameParent(!1),null===controls&&(interactionState=0)),controls&&dropConfig){if(2===interactionState)command={name:"CopyMoveControls",deltaPosition:{left:null,top:null},controls,frameworkType:TCHMI_DESIGNER?"Designer":"LiveView",targetPartial:TCHMI_TARGET_PARTIAL,targetParentControl:dropConfig.tco.getId(),replyTo:null};else if(1===interactionState&&(command={name:"HierarchyMoveControls",deltaPosition:{left:null,top:null},controls,frameworkType:TCHMI_DESIGNER?"Designer":"LiveView",targetPartial:TCHMI_TARGET_PARTIAL,targetParentControl:dropConfig.tco.getId(),replyTo:null},controls.includes(dropConfig.tco.getId())))return this.__mouseMoving=!1,void this.resetState();if(0!==interactionState&&activeTco){null===dropConfig.rowIndex&&(dropConfig.rowIndex=0),null===dropConfig.columnIndex&&(dropConfig.columnIndex=0);let oldRowIndex=activeTco.getGridRowIndex(),oldColumnIndex=activeTco.getGridColumnIndex();1===interactionState&&dropConfig.rowIndex===oldRowIndex&&dropConfig.columnIndex===oldColumnIndex&&dropConfig.tco===activeTco.getParent()?interactionState=0:!command||dropConfig.rowIndex===oldRowIndex&&dropConfig.columnIndex===oldColumnIndex||(command.attributes=[{name:"data-tchmi-grid-row-index",value:dropConfig.rowIndex},{name:"data-tchmi-grid-column-index",value:dropConfig.columnIndex}])}if(0!==interactionState&&null!==ac.parent&&null!==ac.controlAttributeDimension.topValue&&"px"===ac.controlAttributeDimension.topUnit&&null!==ac.controlAttributeDimension.heightValue&&"px"===ac.controlAttributeDimension.heightUnit&&"Value"===ac.controlAttributeDimension.heightMode&&0===ac.absoluteParentRotation&&dropConfig.jHighlighter&&command){let acBCR=ac.jOriginalPosition.parent()[0].getBoundingClientRect(),targetBCR=dropConfig.jHighlighter[0].getBoundingClientRect();command.deltaPosition.top=Math.round(deltaTop+(acBCR.top-targetBCR.top))}if(0!==interactionState&&null!==ac.parent&&null!==ac.controlAttributeDimension.leftValue&&"px"===ac.controlAttributeDimension.leftUnit&&null!==ac.controlAttributeDimension.widthValue&&"px"===ac.controlAttributeDimension.widthUnit&&"Value"===ac.controlAttributeDimension.widthMode&&dropConfig.jHighlighter&&command&&0===ac.absoluteParentRotation){let acBCR=ac.jOriginalPosition.parent()[0].getBoundingClientRect(),targetBCR=dropConfig.jHighlighter[0].getBoundingClientRect();command.deltaPosition.left=Math.round(deltaLeft+(acBCR.left-targetBCR.left))}}if(2===interactionState&&command&&"CopyMoveControls"===command.name)new SyncCmdToCreatorCopyMoveControls(command).send(),metaDataManager.resetChangedControlsMetaData();else if(1===interactionState&&command&&"HierarchyMoveControls"===command.name)new SyncCmdToCreatorHierarchyMoveControls(command).send(),metaDataManager.resetChangedControlsMetaData();else if(0===interactionState&&activeTco){const ctrlList=[],hierarchy=TcHmi.System.resolveControlHierarchy(activeTco,null),hierarchyRecursion=function(h){if(h.ctrl.getIsContainerControl())for(let i=0,ii=h.children_hierarchy.length;i<ii;i++){let childHierarchy=h.children_hierarchy[i];ctrlList.push(childHierarchy.ctrl),hierarchyRecursion(childHierarchy)}};hierarchyRecursion(hierarchy),highlightManager.setContainerPositions(new Set(ctrlList)),this.__controlMoveActive=!1,syncManager.updatePcElementAndSync("System.onControlPositionParameterChanged"),designerModeManager.resyncSelectedControls(),designerModeManager.resyncControls()}}this.__mouseMoving=!1,this.resetState()}}})();export{DesignerModeMasterControlMoveManager};export const controlMoveManager=new DesignerModeMasterControlMoveManager;